<!DOCTYPE html>

<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Pembukuan Rental PS - URBAN DIGITAL (Theme Toggle)</title>
<style>
  /* ========= THEME TOKENS ========= */
  :root {
    /* Dark (default) ‚Äî using your original palette */
    --bg:#0b1020;
    --text:#e9eef9;
    --muted:#9aa3b2;
    --accent:#6ea8fe;
    --ring:#2a3358;

    --card:#111833;   /* main card */
    --card2:#0e1530;  /* sub card */
    --input-bg:#0e1530;
    --btn-bg:#0f1a3d;
    --warn-bg:#2d1f00;
    --warn-ring:#5b3f00;

    --table-border:#232c52;
    --shadow:0 10px 30px rgba(0,0,0,.25);
  }

:root {
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 16px;
  --space-4: 24px;
  --space-5: 32px;
  --ctrl-h: 40px;
  --radius: 8px;
}

  /* Light theme overrides */
  [data-theme="light"]{
    --bg:#f6f7fb;
    --text:#0e1325;
    --muted:#55607a;
    --accent:#2557e0;
    --ring:#d3daf0;

    --card:#ffffff;
    --card2:#f1f4fe;
    --input-bg:#ffffff;
    --btn-bg:#e9edfb;
    --warn-bg:#fff3cd;
    --warn-ring:#ffe08a;

    --table-border:#e2e7fb;
    --shadow:0 6px 18px rgba(0,0,0,.08);
  }

  /* ========= BASE ========= */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Segoe UI,Roboto,Arial,ui-sans-serif;background:var(--bg);color:var(--text);transition:background .25s ease,color .25s ease}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}

  .header{display:flex;align-items:center;justify-content:space-between;gap: var(--space-2)}
  .title{font-size:28px;font-weight:800}
  .subtitle{color:var(--muted);font-size:14px}

  .card{background:var(--card);border:1px solid var(--ring);border-radius: calc(var(--radius) * 2);box-shadow:var(--shadow)}
  .pad{padding: var(--space-3)}
  .grid{display:grid;gap: var(--space-2)}
  .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media(max-width:900px){.g4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(max-width:600px){.g4,.g3{grid-template-columns:1fr}}

  label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
  input,select,button,textarea{font:inherit}

  .input,.select{width:100%;padding: var(--space-2);border-radius: var(--radius);border:1px solid var(--ring);background:var(--input-bg);color:var(--text);outline:none;transition:background .2s ease,border-color .2s ease}
  .btn{border:1px solid var(--ring);background:var(--btn-bg);color:var(--text);padding: var(--space-2) 14px;border-radius: var(--radius);cursor:pointer;transition:filter .15s ease,opacity .15s ease}
  .btn:hover{filter:brightness(1.05)}
  .btn.primary{border-color:transparent;background:var(--accent);color:#fff}
  .btn.warn{background:var(--warn-bg);border-color:var(--warn-ring);color:#4f2a00}

  .row{display:flex;gap: var(--space-2);flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:var(--card2);border:1px solid var(--ring);border-radius:999px}
  .pill .select{padding: var(--space-1) 10px}

  table{width:100%;border-collapse:collapse}
  th,td{padding: var(--space-2); vertical-align: middle;}
  th:first-child,td:first-child{text-align:left}
  th{color:var(--muted);font-size:13px}
  .mono{font-variant-numeric:tabular-nums}
  .right{text-align:right}
  .spacer{height: var(--ctrl-h)}
  .note{color:var(--muted);font-size:12px}
  .subtle{color:var(--muted)}
  .mini{font-size:12px}
  .table-sm th,.table-sm td{padding: var(--space-1) var(--space-2);}
  .total-row td{font-weight:800;border-top:2px solid var(--ring);border-bottom:none}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--card2);border:1px solid var(--ring);font-size:12px}

  /* Section card variants that previously used hardcoded colors */
  .subcard{background:var(--card2);border:1px solid var(--ring);border-radius: calc(var(--radius) * 2)}
  .subcard .pad{padding: var(--space-3)}

  /* Range pill spacing */
  #rangePill { gap:8px }
  #rangePill .input { padding: var(--space-1) 10px }
  #rangePill .btn { padding:8px 10px }

  /* === Recap styles === */
  .recap{display:grid;gap: var(--space-2);grid-template-columns:repeat(4,minmax(0,1fr));margin:6px 0 0}
  .recap-item{display:flex;align-items:center;gap: var(--space-2);background:var(--card2);border:1px solid var(--ring);border-radius: var(--radius);padding: var(--space-2)}
  .recap-item .label{font-size:12px;color:var(--muted)}
  .recap-item .value{font-weight:800;font-variant-numeric:tabular-nums}
  @media(max-width:900px){.recap{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(max-width:600px){.recap{grid-template-columns:1fr}}


/* === Custom red warning buttons === */
.btn.warn {
  background: #d93025 !important; /* Red tone */
  border-color: #a12016 !important;
  color: #fff !important;
}
.btn.warn:hover {
  filter: brightness(1.1);
}


/* === Filter bar consistency === */
.pill {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: var(--space-1) 10px;
  background: var(--card2);
  border: 1px solid var(--ring);
  border-radius: 999px;
}

.pill select,
.pill input,
.pill button {
  height: var(--ctrl-h);            /* consistent height */
  padding: 0 10px;
  font-size: 13px;
  border-radius: 6px;
}

.pill select {
  min-width: 130px;        /* proportion for dropdown */
}

.pill input[type="date"] {
  min-width: 140px;        /* proportion for date inputs */
}

.pill button {
  white-space: nowrap;
}


/* Force all controls inside pill to be equal height */
.pill select,
.pill input[type="date"],
.pill button {
  height: var(--ctrl-h) !important;       /* exact same height */
  line-height: var(--ctrl-h);
  padding: 0 10px !important;     /* same padding */
  font-size: 13px;
  border-radius: 6px;
  box-sizing: border-box;
}

/* Make date picker icon vertically aligned */
.pill input[type="date"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}


/* ===== Modal ===== */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter:saturate(120%) blur(2px);
  z-index:9998;
}
.modal{
  position:fixed; inset:0; display:grid; place-items:center; z-index:9999;
}
.modal[hidden], .modal-backdrop[hidden]{ display:none !important; }

.modal > *{
  width:min(560px, calc(100% - 32px));
  background:var(--card);
  color:var(--text);
  border:1px solid var(--ring);
  border-radius: calc(var(--radius) * 2);
  box-shadow:var(--shadow);
}

.modal-header{
  display:flex; align-items:center; justify-content:space-between; gap: var(--space-2);
  padding: var(--space-2) 16px; border-bottom:1px solid var(--ring);
}
.modal-title{ font-weight:800; font-size:16px; }
.modal-close{
  background:transparent; border:1px solid var(--ring); color:var(--text);
  border-radius: var(--radius); padding: var(--space-1) 10px; cursor:pointer;
}

.modal-body{ padding: var(--space-3); font-size:14px; }
.modal-footer{
  padding: var(--space-2) 16px; display:flex; gap: var(--space-2); justify-content:flex-end; border-top:1px solid var(--ring);
}

/* ===== Modal Animations ===== */
.modal-backdrop{
  opacity: 0;
  transition: opacity .18s ease-out;
}
.modal-backdrop.is-visible{
  opacity: 1;
}

/* Panel animasi: muncul naik sedikit + fade */
.modal > *{
  transform: translateY(8px) scale(.98);
  opacity: 0;
  transition: transform .22s ease-out, opacity .22s ease-out, box-shadow .22s ease-out;
}
.modal.is-visible > *{
  transform: none;
  opacity: 1;
}


  /* === Form action row (Add / Cancel) === */
  .actions-row{display:flex;gap: var(--space-2);width:100%;justify-content:flex-end}
  .actions-row.editing{justify-content:space-between}
  .actions-row .btn{min-width:120px}
  .actions-row.editing .btn{flex:1;max-width:220px}
  #cancelEditBtn{order:0}
  #addBtn{order:1}


  .actions-row.editing #cancelEditBtn {
    flex: 0 0 auto;
    max-width: none;
    padding: 0 16px;
  }


/* === Daily Graph styles === */
.graph-tooltip {
  position: absolute;
  pointer-events: none;
  font-size: 12px;
  background: var(--card2);
  color: var(--text);
  border: 1px solid var(--ring);
  border-radius: 8px;
  padding: var(--space-1) 8px;
  box-shadow: var(--shadow);
  transform: translate(-50%, -120%);
  white-space: nowrap;
  z-index: 10;
}
#graphCard.pulse {
  box-shadow: 0 0 0 0 rgba(110,168,254,.8);
  animation: pulseCard 1.2s ease-out 2;
}
@keyframes pulseCard {
  0% { box-shadow: 0 0 0 0 rgba(110,168,254,.7); }
  100% { box-shadow: 0 0 0 18px rgba(110,168,254,0); }
}

/* === Compact spacing for graph === */
#graphCard {
  padding: 8px 12px !important;
}
#graphCard .mini.subtle {
  font-size: 11px !important;
}
#graphCard canvas { width: 100% !important; height: auto !important; aspect-ratio: 16 / 6; }
.spacer {
  height: var(--ctrl-h) !important;
}

/* === Fix Harga column in Jasa & Aksesoris table === */
#jasaTable2x5 td:last-child,
#jasaTable2x5 th:last-child {
  min-width: 100px;
  text-align: right;
}
#jasaTable2x5 input.jasa-price {
  text-align: right;
  width: 100%;
  box-sizing: border-box;
}

/* === Clean & stable layout for Jasa & Aksesoris table === */
#jasaTable2x5{
  table-layout: fixed;              /* prevent jitter */
}
#jasaTable2x5 input.jasa-price{
  text-align: right;
  width: 100%;
  padding-right: 8px;
}
#jasaTable2x5 .jasa-note{
  width: 100%;
}
#jasaTable2x5 .jasa-type{
  width: 100%;
}

/* Keep other tables unaffected */

/* === Proportional layout for Jasa & Aksesoris table === */
#jasaTable2x5{
  table-layout: fixed;
  width: 100%;
}
#jasaTable2x5 th, #jasaTable2x5 td{
  vertical-align: middle;
}
#jasaTable2x5 td:nth-child(4), #jasaTable2x5 th:nth-child(4){
  text-align: right;
}
#jasaTable2x5 input.jasa-price{
  text-align: right;
  width: 100%;
  padding-right: 8px;
}
#jasaTable2x5 .jasa-note{
  width: 100%;
}
#jasaTable2x5 .jasa-type{
  width: 100%;
}

/* === Match proportions to Rincian Pemasukan Jajanan === */
#jasaTable2x5{
  table-layout: fixed;
  width: 100%;
}
#jasaTable2x5 th, #jasaTable2x5 td{
  vertical-align: middle;
}
#jasaTable2x5 td:nth-child(4), #jasaTable2x5 th:nth-child(4){
  text-align: right;
}
#jasaTable2x5 input.jasa-price{
  text-align: right;
  width: 100%;
  padding-right: 8px;
}
#jasaTable2x5 .jasa-note{
  width: 100%;
}
#jasaTable2x5 .jasa-type{
  width: 100%;
}

/* === Exact proportions for Jasa & Aksesoris table === */
#jasaTable2x5{
  table-layout: fixed;
  width: 100%;
}
#jasaTable2x5 th, #jasaTable2x5 td{
  vertical-align: middle;
}
#jasaTable2x5 td:nth-child(4), #jasaTable2x5 th:nth-child(4){
  text-align: right;
}
#jasaTable2x5 input.jasa-price{
  text-align: right;
  width: 100%;
  padding-right: 8px;
}
#jasaTable2x5 .jasa-note{
  width: 100%;
}
#jasaTable2x5 .jasa-type{
  width: 100%;
}

/* === Harga input left aligned === */
#jasaTable2x5 input.jasa-price{
  text-align: left !important;
}

/* === Right-aligned helper for notes === */
.auto-note{ margin-left:auto; text-align:left;  white-space:nowrap;}
/** Footer rows alignment for new totals **/
#table tfoot .total-row td:first-child{ text-align:left; }

/* === Filter Card (square-rounded, precise) === */
.filter-card{ border-radius: calc(var(--radius) * 2); background:var(--card2); border:1px solid var(--ring); }
.filter-grid{ display:grid; grid-template-columns: 140px 1fr; gap: var(--space-2) 16px; align-items:center; }
.filter-grid .f-row{ display:contents; } /* allow label + control align on same row */
.filter-grid label{ font-size:14px; color:var(--muted); font-weight:600; }
.filter-card .select, .filter-card .input{ height: var(--ctrl-h); border-radius: var(--radius); }
.filter-card .range-wrap{ display:flex; flex-wrap:wrap; gap: var(--space-2); align-items:center; }
.filter-card .range-wrap .input{ width:180px; }
.filter-card .range-wrap .sep{ color:var(--muted); min-width:24px; text-align:center; }
.filter-card .btn{ height: var(--ctrl-h); border-radius: var(--radius); padding:0 14px; }
@media (max-width: 700px){
  .filter-grid{ grid-template-columns: 1fr; }
  .filter-grid label{ margin-bottom:4px; }
  .filter-card .range-wrap{ gap:8px; }
  .filter-card .range-wrap .input{ flex:1 1 160px; min-width:0; }
  .filter-card .btn{ flex:1 1 auto; }
  .filter-card .sep{ order:2; } /* keep natural reading on wrap */
}


.g2 { 
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: var(--space-2);
}
.g4 { 
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: var(--space-2);
}

/* Responsif */
@media (max-width: 900px) {
  .g2 { grid-template-columns: 1fr; }
  .g4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
}

.g2 { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap: var(--space-2); }

/* === Responsive Typography (8pt Grid System) === */
:root {
  --font-xs: 12px;
  --font-sm: 14px;
  --font-md: 16px;
  --font-lg: 20px;
  --font-xl: 24px;
  --font-2xl: 32px;
}

/* Base text */
body {
  font-size: var(--font-md);
  line-height: 1.5;
}

/* Titles */
.title {
  font-size: var(--font-xl);
  font-weight: 800;
  line-height: 1.3;
}
.subtitle {
  font-size: var(--font-sm);
}

/* Table text */
th, td {
  font-size: var(--font-sm);
}

/* Small labels and notes */
label, .mini, .note, .subtle {
  font-size: var(--font-xs);
}

/* Responsive adjustments */
@media (max-width: 900px) {
  body { font-size: var(--font-sm); }
  .title { font-size: var(--font-lg); }
}
@media (max-width: 600px) {
  body { font-size: var(--font-sm); }
  .title { font-size: 18px; } /* mobile-friendly */
  .subtitle { font-size: var(--font-xs); }
  th, td { font-size: var(--font-xs); }
}


/* === Fluid Typography & Spacing (8pt Grid System with clamp) === */
:root {
  --space-1: clamp(4px, 0.5vw, 6px);
  --space-2: clamp(8px, 1vw, 12px);
  --space-3: clamp(16px, 2vw, 20px);
  --space-4: clamp(24px, 3vw, 32px);
  --space-5: clamp(32px, 4vw, 40px);
  --ctrl-h: clamp(36px, 5vw, 48px);
  --radius: 8px;
}

/* Typography */
body { font-size: clamp(14px, 1.6vw, 16px); line-height: 1.5; }
.title { font-size: clamp(20px, 3vw, 32px); font-weight: 800; line-height: 1.3; }
.subtitle { font-size: clamp(12px, 1.4vw, 16px); }
th, td { font-size: clamp(12px, 1.4vw, 14px); }
label, .mini, .note, .subtle { font-size: clamp(11px, 1.2vw, 12px); }

/* Buttons & Inputs */
.input, .select, .btn, textarea {
  min-height: var(--ctrl-h);
  border-radius: var(--radius);
  padding: 0 var(--space-2);
  font-size: inherit;
}

/* Card & Grid Spacing */
.card .pad, .subcard .pad { padding: var(--space-3); }
.grid, .row { gap: var(--space-2); }
.spacer { height: var(--space-3); }

/* Table padding */
th, td { padding: var(--space-2); vertical-align: middle; }
.table-sm th, .table-sm td { padding: var(--space-1) var(--space-2); }

/* Graph fix (aspect ratio, responsive) */
#graphCard canvas { width: 100% !important; height: auto !important; aspect-ratio: 16 / 6; }


/* === Fix: Konsistensi kolom "No." di semua tabel rincian === */
#rincianTable th:first-child, #rincianTable td:first-child,
#jajananTable3x10 th:first-child, #jajananTable3x10 td:first-child,
#jasaTable2x5 th:first-child, #jasaTable2x5 td:first-child,
#sewaTable3x10 th:first-child, #sewaTable3x10 td:first-child {
  width: 48px;
  min-width: 48px;
  max-width: 48px;
  text-align: center;
}


/* === Fix v2: Konsistensi & Simetris kolom "No." di semua tabel rincian === */
#rincianTable th:first-child, #rincianTable td:first-child,
#jajananTable3x10 th:first-child, #jajananTable3x10 td:first-child,
#jasaTable2x5 th:first-child, #jasaTable2x5 td:first-child,
#sewaTable3x10 th:first-child, #sewaTable3x10 td:first-child {
  box-sizing: border-box;
  width: 48px;
  min-width: 48px;
  max-width: 48px;
  text-align: center;
  padding-left: 0;
  padding-right: 0;
}

</style>
<style id="ui-fix-0811">
/* === UI Polishing: consistent proportions & spacing === */
:root{
  --space-1:8px;
  --space-2:12px;
  --space-3:16px;
  --space-4:20px;
  --ctrl-h:40px;
  --radius:12px;
}

/* normalize gaps */
.row{ gap: var(--space-2) !important; }
.grid{ gap: var(--space-2) !important; }
.spacer{ height: var(--space-3) !important; }

/* cards & subcards padding symmetry */
.card .pad, .subcard .pad{ padding: var(--space-3) !important; }
.card, .subcard{ border-radius: calc(var(--radius) * 2) !important; }

/* controls: same height/padding/radius */
.input, .select, .btn, textarea{
  min-height: var(--ctrl-h);
  border-radius: var(--radius);
  padding-top: 8px; padding-bottom: 8px;
}
textarea{ padding-top: 10px; padding-bottom: 10px; }

/* pills: ensure same inner heights and spacing */
.pill{ gap: var(--space-1) !important; }
.pill select, .pill input[type="date"], .pill button{
  height: calc(var(--ctrl-h) - 4px) !important;
  line-height: calc(var(--ctrl-h) - 4px);
  padding: 0 10px !important;
  border-radius: 8px;
}

/* tables: consistent density & alignment */
.table-sm th, .table-sm td{ padding: var(--space-2) 12px !important; }
th, td{ vertical-align: middle; }
th:first-child, td:first-child{ text-align: left; }

/* top form: keep clean spacing & alignment */
.container .card .grid > div label{ margin-bottom: 6px !important; }
.container .card .grid input.input{ width: 100%; }

/* action row: same spacing left-right when editing */
.actions-row{ gap: var(--space-2) !important; }
.actions-row.editing{ justify-content: space-between !important; }
#cancelEditBtn{ margin-right: auto; } /* keep "Batal" on the left */

/* ensure graph & footer spacing is even */
#graphCard{ margin-top: var(--space-3); }
#graphCard + div{ margin-top: var(--space-3) !important; } /* footer wrapper */

/* Jasa & Aksesoris proportions (already set via colgroup) + clean inputs */
#jasaTable2x5 input.jasa-price{ text-align: left !important; }
#jasaTable2x5 colgroup col:nth-child(2),
#jasaTable2x5 colgroup col:nth-child(3),
#jasaTable2x5 colgroup col:nth-child(4){ width:31.6% !important; }

/* prevent layout jump on inputs (tabular) */
.mono{ font-variant-numeric: tabular-nums; }

/* responsive: stack cleanly on small screens */
@media(max-width:900px){
  .header{ align-items: flex-start; }
}
@media(max-width:600px){
  .row{ gap: var(--space-1) !important; }
  .btn{ min-width: auto; }
}
</style>
<style id="mobile-polish-0811">
/* ===== Mobile polish (safe, symmetric, no-left-stretch) ===== */
html, body { overflow-x: hidden; }

/* Safe-area padding for phones with notches + equal side padding */
.container{
  padding-left: max(16px, env(safe-area-inset-left));
  padding-right: max(16px, env(safe-area-inset-right));
}

/* Header buttons wrap neatly */
.header{ flex-wrap: wrap; gap: 8px; }
.header .row{
  flex-wrap: wrap;
  margin-left: auto;          /* push actions to the right on wide screens */
  justify-content: flex-end;
  gap: 8px;
}

/* Top form grid: 5 -> 2 -> 1 columns responsively */
.g5{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
@media (max-width: 900px){
  .g5{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 600px){
  .g5{ grid-template-columns: 1fr; }
  .title{ font-size: 22px; line-height: 1.2; }
  .header .row{ width: 100%; margin-left: 0; justify-content: flex-start; }
}

/* Make pills/filters not stretch awkwardly on mobile */
.pill{ width: 100%; max-width: 100%; }
@media (min-width: 601px){
  .pill{ width: auto; }
}

/* Smooth scrolling for in-app navigation */
html { scroll-behavior: smooth; }

/* === Merged Filter + Rentang pill === */
.pill-merged{
  display:flex;
  align-items:center;
  gap: var(--space-2);
  padding:8px 12px;
  background:var(--card2);
  border:1px solid var(--ring);
  border-radius:999px;
}
.pill-merged .seg{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.pill-merged .divider{
  width:1px;
  align-self:stretch;
  background:var(--ring);
  opacity:.6;
}
/* Make the merged pill full-width on small screens for symmetry */
@media (max-width: 600px){
  .pill-merged{ width:100%; }
}


/* === Toolbar polish: consistent heights & tidy wrap === */
.toolbar-row{
  display:flex;
  flex-wrap:wrap;
  gap: var(--space-2);
  align-items:center;
}
.toolbar-row .pill,
.toolbar-row .pill-merged{
  min-height: calc(var(--ctrl-h) + 4px);
}
/* Metric pill (for totals) */
.pill.metric{
  display:flex;
  align-items:center;
  gap: var(--space-2);
  padding:8px 12px;
  background:var(--card2);
  border:1px solid var(--ring);
  border-radius:999px;
}
.pill.metric .label{
  font-size:12px;
  color:var(--muted);
}
.pill.metric .value{
  font-weight:800;
  font-variant-numeric: tabular-nums;
}
/* Keep danger button aligned in the pill */
.pill.metric .btn{
  height: calc(var(--ctrl-h) - 4px) !important;
  line-height: calc(var(--ctrl-h) - 4px);
  padding: 0 12px !important;
  border-radius: 8px;
}

/* Responsive: make items fill nicely on small screens */
@media (max-width: 900px){
  .toolbar-row > *{ flex:1 1 auto; }
}
@media (max-width: 600px){
  .toolbar-row .pill-merged,
  .toolbar-row .pill.metric{
    width:100%;
  }
}


/* === Catatan & Button precise alignment === */
.catatan-row {
  display: flex;
  gap: var(--space-2);
  align-items: flex-end;
}

.catatan-wrap {
  flex: 1; /* Catatan takes all free space */
}

.actions-wrap {
  flex: 0 0 auto; /* Button only as wide as needed */
}

#formActions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

@media (max-width: 600px) {
  .catatan-row {
    flex-direction: column;
    align-items: stretch;
  }
  .actions-wrap {
    width: 100%;
  }
  #formActions {
    justify-content: flex-start;
  }
}
</style>
<style>
#jajananSettingsModal .modal-body {
  max-height: 80vh;
  overflow-y: auto;
}
#jajananSettingsModal table {
  width: 100%;
  border-collapse: collapse;
}
#jajananSettingsModal th, #jajananSettingsModal td {
  padding: var(--space-1);
  border-bottom: 1px solid var(--ring);
}
</style>
<style>
#popupBackdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    z-index: 1000;
}
#popupBackdrop.is-visible {
    opacity: 1;
}
.modal {
    z-index: 1001;
}
</style>
<style>
.settings-sidebar .btn {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: var(--space-2);
    width: 100%;
    text-align: left;
    padding: var(--space-2) 18px;
    border: 2px solid var(--ring);
    border-radius: 8px;
    background: var(--card2);
    font-size: 14px;
    white-space: nowrap;
    transition: background 0.2s, color 0.2s;
}
.settings-sidebar .btn span.emoji {
    flex-shrink: 0;
    font-size: 18px;
    line-height: 1;
}
.settings-sidebar .btn:hover {
    background: var(--hover);
}
.settings-sidebar .btn.active {
    background: #1C308A;
    color: #fff;
    border-color: #1C308A;
}
</style>










<style>
  /* Header tetap tengah */
  table th {
    text-align: center !important;
  }

  /* Default isi tabel kiri */
  table td {
    text-align: left !important;
  }

  /* Angka uang kanan */
  table td.mono,
  table td.right,
  #rincianTotal, #jajananTotal3x10, #jasaTotal2x5, #sewaTotal3x10,
  #recapBar .value, #grandTotal,
  #sumHarian, #sumJajanan, #sumJasa, #sumSewa, #sumTotal, #sumMonth, #sumAll {
    text-align: right !important;
  }

  /* Label TOTAL & TOTAL KESELURUHAN tetap kiri */
  .total-row td:first-child,
  .total-row td[colspan] {
    text-align: left !important;
  }
</style>


<style>
  /* Pastikan baris TOTAL rapih dan simetris */
  .total-row td {
    font-weight: 800;
  }
  .total-row td[colspan] {
    text-align: left !important;
  }
  .total-row td.mono {
    text-align: right !important;
    min-width: 120px; /* jaga konsistensi lebar kolom harga */
  }
</style>


<style>
#jajananTable3x10 {
  width: 100% !important;
  table-layout: auto;
}
</style>



<style>
/* Stretch the Jajanan table to container width without causing horizontal scroll */
#jajananTable3x10 {
  width: 100% !important;
  table-layout: fixed; /* predictable column sizing */
}
/* Proportional column widths to avoid "gepeng" */
#jajananTable3x10 col:nth-child(1) { width: 48px; }           /* No. */
#jajananTable3x10 col:nth-child(2) { width: 44%; min-width: 200px; } /* Jenis */
#jajananTable3x10 col:nth-child(3) { width: 14%; min-width: 90px; }  /* Qty */
#jajananTable3x10 col:nth-child(4) { width: 18%; min-width: 120px; } /* Jam */
#jajananTable3x10 col:nth-child(5) { width: 24%; min-width: 120px; } /* Harga */
/* Make inputs/selects fill their cells neatly */
#jajananTable3x10 input, #jajananTable3x10 select {
  width: 100%;
  box-sizing: border-box;
}
/* Keep harga right-aligned, prevent numbers from wrapping */
#jajananTable3x10 .j3-harga {
  text-align: right;
  white-space: nowrap;
}
/* Avoid extra overflow from the wrapper; rely on 100% table width */
#jajananTable3x10 ~ tfoot, #jajananTable3x10 tfoot td {
  white-space: nowrap;
}
</style>


<style>
/* Fix alignment for TOTAL row in Jajanan table */
#jajananTable3x10 tfoot .total-row td {
  font-weight: 800;
}
#jajananTable3x10 tfoot .total-row td:first-child {
  text-align: left !important;
}
#jajananTable3x10 tfoot .total-row td.mono {
  text-align: right !important;
  min-width: 120px;
}
</style>

</head>
<body>
<div class="container">
<div class="header">
<div>
<div class="title">PEMBUKUAN RENTAL PS ‚Äî URBAN GAMING LAMPUNG DIGITAL</div>
<div class="subtitle">URBAN PlayStation Lampung üéÆ</div>
</div>
<div class="row toolbar-row">
<button class="btn" id="themeBtn" title="Ganti tema"><span class="emoji">üåô</span>Gelap</button>
<button class="btn" id="exportReportBtn">üìù Download Laporan</button>
<button class="btn" id="settingsBtn">‚öô Pengaturan</button>
</div>
</div>
<div class="spacer"></div>
<div class="card pad">
<!-- Row 1: Date & Day -->
<div class="grid g2 top-form">
<div>
<label>Tanggal</label>
<input class="input" id="date" type="date"/>
</div>
<div>
<label>Hari</label>
<input class="input" id="day" readonly="" style="background-color: var(--card2); color: var(--muted);" type="text"/>
</div>
</div>
<!-- Row 2: Absen & Ruko -->
<div class="grid g4" style="margin-top: var(--space-2);">
<div>
<label>Absen Pagi</label>
<input class="input" id="absenPagi" required="" type="time"/>
</div>
<div>
<label>Absen Siang</label>
<input class="input" id="absenSiang" required="" type="time"/>
</div>
<div>
<label>Ruko Buka</label>
<input class="input" id="rukoBuka" required="" type="time"/>
</div>
<div>
<label>Ruko Tutup</label>
<input class="input" id="rukoTutup" required="" type="time"/>
</div>
</div>
<!-- Hidden fields -->
<input id="harian" type="hidden" value="0"/>
<input id="jajanan" type="hidden" value="0"/>
<input id="jasa" type="hidden" value="0"/>
<input id="sewa" type="hidden" value="0"/>
<div class="spacer"></div>
<div class="row catatan-row">
<div class="catatan-wrap">
<label>Catatan (opsional)</label>
<input class="input" id="catatan" placeholder="misal : Ada yang belum bayar" type="text"/>
</div>
<div class="actions-wrap">
<label style="visibility:hidden">.</label>
<div class="actions-row" id="formActions">
<button class="btn warn" id="cancelEditBtn" style="display:none;">Batal</button>
<button class="btn primary" id="addBtn">+ Tambah Pencatatan</button>
</div>
</div>
</div>
<div class="spacer"></div>
<!-- Rincian Pemasukan Harian -->
<div class="subcard">
<div class="pad">
<div class="row" style="justify-content:space-between;align-items:center">
<div><b>Rincian Pemasukan Harian</b> <span class="badge">10 baris</span></div>
<div class="mini subtle">Kolom: 1) No. 2) Jenis PS 3) Jam Masuk 4) Jumlah Jam 5) Harga</div>
</div>
<div style="overflow:auto;margin-top: var(--space-2)">
<table class="table-sm" id="rincianTable">
<thead>
<tr>
<th>No.</th>
<th>Jenis PS</th>
<th>Jam Masuk</th>
<th>Jumlah Jam</th>
<th>Harga (Rp)</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr class="total-row">
<td class="right" colspan="4">TOTAL</td>
<td class="mono right" id="rincianTotal">Rp 0</td>
</tr>
<tr class="total-row">
<td colspan="9" style="text-align:left; padding-top:8px;">
</td>
</tr>
</tfoot>
</table>
</div>
<div class="row" style="margin-top: var(--space-2)">
<button class="btn" id="rincianClear" type="button">Kosongkan Rincian</button>
<button class="btn primary" id="rincianAddRow" type="button">+ Tambah Baris</button>
<span class="mini subtle auto-note">Total otomatis masuk ke kolom <b>Pemasukan Harian</b>.</span>
</div>
</div>
</div>
<div class="spacer"></div>
<!-- Rincian Pemasukan Jajanan (3 kolom √ó 10 baris) -->
<div class="subcard">
<div class="pad">
<div class="row" style="justify-content:space-between;align-items:center">
<div><b>Rincian Pemasukan Jajanan</b> <span class="badge">4 kolom √ó 10 baris</span></div>
<div class="mini subtle">Kolom: 1) Jenis ‚Ä¢ 2) Qty ‚Ä¢ 3) Jam ‚Ä¢ 4) Harga (otomatis)</div>
</div>
<div style="margin-top: var(--space-2)">
<table class="table-sm" id="jajananTable3x10"><colgroup><col/><col/><col/><col/><col/></colgroup>
<thead>
<tr><th>No.</th><th>Jenis Jajanan</th><th>Qty</th><th>Jam</th><th>Harga (Rp)</th></tr>
</thead>
<tbody></tbody>
<tfoot>
<tr class="total-row">
<td class="right" colspan="4">TOTAL</td>
<td></td>
<td class="mono right" id="jajananTotal3x10">Rp 0</td>
</tr>
<tr class="total-row">
<td colspan="9" style="text-align:left; padding-top:8px;">
</td>
</tr>
</tfoot>
</table>
</div>
<div class="row" style="margin-top: var(--space-2)">
<button class="btn" id="jajanan3x10Clear" type="button">Kosongkan Rincian</button>
<button class="btn primary" id="jajanan3x10AddRow" type="button">+ Tambah Baris</button>
<span class="mini subtle auto-note">Total otomatis ‚Üí kolom <b>Pemasukan Jajanan</b>.</span>
</div>
</div>
</div>
<div class="spacer"></div>
<!-- Rincian Pemasukan Jasa & Aksesoris (3 kolom √ó 5 baris) -->
<div class="subcard">
<div class="pad">
<div class="row" style="justify-content:space-between;align-items:center">
<div><b>Rincian Pemasukan Jasa &amp; Aksesoris</b> <span class="badge">3 kolom √ó 5 baris</span></div>
<div class="mini subtle">Kolom: 1) Tipe (drop-down) ‚Ä¢ 2) Keterangan (manual) ‚Ä¢ 3) Harga (manual)</div>
</div>
<div style="overflow:auto;margin-top: var(--space-2)">
<table class="table-sm" id="jasaTable2x5"><colgroup><col style="width:5.2%"/><col style="width:31.6%"/><col style="width:31.6%"/><col style="width:31.6%"/></colgroup>
<thead><tr><th>No.</th><th>Tipe</th><th>Keterangan</th><th>Harga (Rp)</th></tr></thead>
<tbody></tbody>
<tfoot><tr class="total-row"><td class="right" colspan="3">TOTAL</td><td class="mono right" id="jasaTotal2x5">Rp 0</td></tr>
<tr class="total-row">
<td colspan="9" style="text-align:left; padding-top:8px;">
</td>
</tr>
</tfoot>
</table>
</div>
<div class="row" style="margin-top: var(--space-2)">
<button class="btn" id="jasa2x5Clear" type="button">Kosongkan Rincian</button>
<button class="btn primary" id="jasa2x5AddRow" type="button">+ Tambah Baris</button>
<span class="mini subtle auto-note">Total otomatis ‚Üí kolom <b>Pemasukan Jasa &amp; Aksesoris</b> di atas.</span>
</div>
</div>
</div>
<div class="spacer"></div>
<!-- Rincian Pemasukan SEWA PS (3 kolom √ó 10 baris) -->
<div class="subcard">
<div class="pad">
<div class="row" style="justify-content:space-between;align-items:center">
<div><b>Rincian Pemasukan SEWA PS</b> <span class="badge">4 kolom √ó 5 baris</span></div>
<div class="mini subtle">Kolom: 1) Jenis PS ‚Ä¢ 2) Lama Sewa ‚Ä¢ 3) Keterangan (opsional) ‚Ä¢ 4) Harga (otomatis bisa diedit)</div>
</div>
<div style="overflow:auto;margin-top: var(--space-2)">
<table class="table-sm" id="sewaTable3x10">
<thead>
<tr>
<th>No.</th><th>Jenis PS</th><th>Lama Sewa</th><th>Keterangan</th><th>Harga (Rp)</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr class="total-row">
<td class="right" colspan="4">TOTAL</td>
<td class="mono right" id="sewaTotal3x10">Rp 0</td>
</tr>
<tr class="total-row">
<td colspan="9" style="text-align:left; padding-top:8px;">
</td>
</tr>
</tfoot>
</table>
</div>
<div class="row" style="margin-top: var(--space-2)">
<button class="btn" id="sewa3x10Clear" type="button">Kosongkan Rincian </button>
<button class="btn primary" id="sewa3x10AddRow" type="button">+ Tambah Baris</button>
<span class="mini subtle auto-note">Total otomatis ‚Üí kolom <b>Sewa PS</b> di atas.</span>
</div>
<div class="spacer"></div>
<!-- Recap ringkas di atas TOTAL KESELURUHAN -->
<div class="recap" id="recapBar">
<div class="recap-item"><div class="label">Pemasukan Harian</div><div class="value mono" id="recapHarian">Rp 0</div></div>
<div class="recap-item"><div class="label">Pemasukan Jajanan</div><div class="value mono" id="recapJajanan">Rp 0</div></div>
<div class="recap-item"><div class="label">Pemasukan Jasa &amp; Aksesoris</div><div class="value mono" id="recapJasa">Rp 0</div></div>
<div class="recap-item"><div class="label">Pemasukan Sewa PS</div><div class="value mono" id="recapSewa">Rp 0</div></div>
</div>
<div class="spacer"></div>
<div class="subcard">
<div class="pad">
<table style="width:100%;border-collapse:collapse">
<tr class="total-row">
<td class="right" colspan="3" style="text-align:left;font-weight:800;">TOTAL KESELURUHAN</td>
<td class="mono right" id="grandTotal">Rp 0</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div><!-- /card pad -->
<div class="spacer"></div>
<!-- Filter & Rentang (clean, square-rounded, responsive) -->
<div class="subcard filter-card">
<div class="pad">
<div class="filter-grid">
<div class="f-row">
<label for="monthFilter">Filter</label>
<select class="select" id="monthFilter"></select>
</div>
<div class="f-row">
<label for="dateFrom">Rentang</label>
<div class="range-wrap">
<input class="input" disabled="" id="dateFrom" type="date"/>
<span class="sep">s/d</span>
<input class="input" disabled="" id="dateTo" type="date"/>
<button class="btn" disabled="" id="rangeApply" type="button">Terapkan</button>
<button class="btn" disabled="" id="rangeClear" title="Kosongkan rentang" type="button">Bersihkan</button>
</div>
</div>
</div>
</div>
</div>
<div class="spacer"></div>
<div class="card pad">
<div style="overflow:auto;">
<div class="row" style="justify-content:space-between;align-items:center">
<div><b>History Pembukuan</b></div>
<div class="mini subtle">Riwayat semua pencatatan pemasukan</div>
</div>
<div style="overflow:auto;margin-top: var(--space-2)">
<table class="table-sm" id="table">
<thead>
<tr>
<th colspan="2" style="text-align:center;">Tanggal &amp; Hari</th>
<th rowspan="2">Harian</th>
<th rowspan="2">Jajanan</th>
<th rowspan="2">Jasa &amp; Aksesoris</th>
<th rowspan="2">Sewa PS</th>
<th rowspan="2">Total</th>
<th rowspan="2">Catatan</th>
<th rowspan="2">Aksi</th>
</tr>
<tr>
<th style="min-width:130px">Tanggal</th>
<th>Hari</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td>Subtotal (tampil)</td><td></td>
<td class="mono right" id="sumHarian">Rp 0</td>
<td class="mono right" id="sumJajanan">Rp 0</td>
<td class="mono right" id="sumJasa">Rp 0</td>
<td class="mono right" id="sumSewa">Rp 0</td>
<td class="mono right" id="sumTotal">Rp 0</td>
<td colspan="2"></td>
</tr>
<tr class="total-row"><td colspan="6">Total bulan ini</td><td class="mono right" id="sumMonth">Rp 0</td><td colspan="2"></td></tr>
<tr class="total-row"><td colspan="6">Total semua</td><td class="mono right" id="sumAll">Rp 0</td><td colspan="2"></td></tr>
<tr class="total-row">
<td colspan="9" style="text-align:left; padding-top:8px;">
<button class="btn warn" id="clearBtn" title="Hapus semua data">Bersihkan Semua History</button>
</td>
</tr>
</tfoot>
</table>
</div>
<div class="note">Tombol <b>Edit</b> nge-load semua rincian ke form di atas biar bisa diperbaiki total.</div>
</div>
</div>
<div class="spacer"></div>
<div class="card pad" id="graphCard">
<div style="display:flex;justify-content:space-between;align-items:center;gap: var(--space-2);margin-bottom:8px">
<div><b>Grafik Total</b> <span class="mini subtle">titik berwarna sesuai ambang</span></div>
<button class="btn" id="saveGraphBtn" title="Simpan grafik sebagai gambar">Simpan Grafik</button>
</div>
<canvas height="260" id="dailyGraph" style="width:100%;display:block"></canvas>
<div class="mini subtle" id="graphCaption" style="margin-top:8px"></div>
</div><div style="color:var(--muted);font-size:12px;text-align:center;margin:16px 0 40px">
    ¬© <span id="year"></span> URBAN GAMING LAMPUNG
  </div>
<div class="spacer"></div>
</div>
<input accept=".csv" id="fileInput" style="display:none" type="file"/>
<script>
// === Themed Popup Helpers ===
(function(){
  function $(sel){ return document.querySelector(sel); }
  function openModal(modalId, opts){
    return new Promise(function(resolve){
      var modal = document.getElementById(modalId);
      var backdrop = document.getElementById('popupBackdrop');
      var bodyEl = modal.querySelector('.modal-body');
      var titleEl = modal.querySelector('.modal-title');
      var okBtn = modal.querySelector('[data-ok]');
      var cancelBtn = modal.querySelector('[data-cancel]');
      var closeBtn = modal.querySelector('[data-close]');

      titleEl.textContent = (opts && opts.title) || titleEl.textContent || '';
      bodyEl.textContent = (opts && opts.message) || '';

      function show(){
        backdrop.hidden = false;
        modal.hidden = false;
        // small async to allow CSS transitions
        requestAnimationFrame(function(){
          backdrop.classList.add('is-visible');
          modal.classList.add('is-visible');
          (okBtn || closeBtn).focus();
        });
      }
      function hide(val){
        backdrop.classList.remove('is-visible');
        modal.classList.remove('is-visible');
        setTimeout(function(){
          backdrop.hidden = true;
          modal.hidden = true;
          cleanup();
          resolve(val);
        }, 200);
      }
      function onKey(e){
        if(e.key === 'Escape'){ hide(modalId === 'themedConfirm' ? false : true); }
      }
      function onBackdrop(e){
        if(e.target === backdrop){ hide(modalId === 'themedConfirm' ? false : true); }
      }
      function cleanup(){
        document.removeEventListener('keydown', onKey);
        backdrop.removeEventListener('click', onBackdrop);
        if(okBtn) okBtn.onclick = null;
        if(cancelBtn) cancelBtn.onclick = null;
        if(closeBtn) closeBtn.onclick = null;
      }

      if(okBtn){ okBtn.textContent = (opts && opts.okText) || 'OK'; okBtn.onclick = function(){ hide(true); }; }
      if(cancelBtn){ cancelBtn.textContent = (opts && opts.cancelText) || 'Batal'; cancelBtn.onclick = function(){ hide(false); }; }
      if(closeBtn){ closeBtn.onclick = function(){ hide(modalId === 'themedConfirm' ? false : true); }; }

      document.addEventListener('keydown', onKey);
      backdrop.addEventListener('click', onBackdrop);

      show();
    });
  }

  window.themedConfirm = function(message, options){
    return openModal('themedConfirm', { message: message, title:(options&&options.title)||'Konfirmasi', okText:(options&&options.okText), cancelText:(options&&options.cancelText) });
  };
  window.themedAlert = function(message, options){
    return openModal('themedAlert', { message: message, title:(options&&options.title)||'Info', okText:(options&&options.okText) });
  };
})();
// === /Themed Popup Helpers ===
</script>
<script>
  // === Themed Password Prompt (matches existing modal/backdrop) ===
  window.themedPromptPassword = function(options){
    return new Promise(function(resolve){
      var modal = document.getElementById('themedPassword');
      var backdrop = document.getElementById('popupBackdrop');
      if(!modal || !backdrop){ return resolve(null); }

      var titleEl = modal.querySelector('.modal-title');
      var input   = modal.querySelector('#pwdInput');
      var okBtn   = modal.querySelector('[data-ok]');
      var cancel  = modal.querySelector('[data-cancel]');
      var close   = modal.querySelector('[data-close]');

      titleEl.textContent = (options && options.title) || 'Verifikasi';
      if(input){
        input.placeholder = (options && options.placeholder) || 'Password admin';
        input.value = '';
      }

      function show(){
        backdrop.hidden = false; modal.hidden = false;
        requestAnimationFrame(function(){
          backdrop.classList.add('is-visible');
          modal.classList.add('is-visible');
          setTimeout(function(){ try{ input && input.focus(); }catch(_){} }, 30);
        });
      }
      function hide(val){
        backdrop.classList.remove('is-visible');
        modal.classList.remove('is-visible');
        setTimeout(function(){
          backdrop.hidden = true; modal.hidden = true;
          cleanup(); resolve(val);
        }, 200);
      }
      function onKey(e){
        if(e.key === 'Escape') hide(null);
        if(e.key === 'Enter')  hide(String((input && input.value) || ''));
      }
      function onBackdrop(e){ if(e.target === backdrop) hide(null); }
      function cleanup(){
        document.removeEventListener('keydown', onKey);
        backdrop.removeEventListener('click', onBackdrop);
        if(okBtn) okBtn.onclick = null;
        if(cancel) cancel.onclick = null;
        if(close) close.onclick = null;
      }

      if(okBtn)   okBtn.onclick   = function(){ hide(String((input && input.value) || '')); };
      if(cancel)  cancel.onclick  = function(){ hide(null); };
      if(close)   close.onclick   = function(){ hide(null); };
      document.addEventListener('keydown', onKey);
      backdrop.addEventListener('click', onBackdrop);
      show();
    });
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(function(){
  function onReady(fn){
    if(document.readyState==='complete' || document.readyState==='interactive'){ setTimeout(fn,0); }
    else document.addEventListener('DOMContentLoaded', fn);
  }

  onReady(function(){

// ===== Pengaturan Jajanan (Integrated inside onReady) =====
(function(){
  var JAJ_PRICE_DEFAULT = {
    "Kopi Panas Original":3000,"Teh Panas":3000,"Es Teh":3000,"Kopi Kapal Api":3000,
    "GoodDay Capuchino Panas":4000,"GoodDay Capuchino Dingin":5000,
    "Luwak White Cofee Panas":4000,"Luwak White Cofee Dingin":5000,
    "Torabika Moka Panas":4000,"Torabika Moka Dingin":5000,
    "Marimas":2000,"Nutrisari":3000,
    "Mie Pakai Telor (Free Nasi)":10000,"Mie Tanpa Telor (Free Nasi)":7000,"Pop Mie (Free Nasi)":8000
  };
  function loadJajananSettings(){
    try {
      var saved = JSON.parse(localStorage.getItem('urban_ps_jajanan_settings')||'{}');
      return Object.assign({}, JAJ_PRICE_DEFAULT, saved);
    } catch(e){
      return Object.assign({}, JAJ_PRICE_DEFAULT);
    }
  }
  function saveJajananSettings(newData){
    localStorage.setItem('urban_ps_jajanan_settings', JSON.stringify(newData));
  }
  function showJajananSettingsModal(){
    var modal = document.getElementById('jajananSettingsModal');
    var backdrop = document.getElementById('popupBackdrop');
    var tbody = document.querySelector('#jajananSettingsTable tbody');
    tbody.innerHTML = '';
    var data = loadJajananSettings();
    Object.keys(data).forEach(function(name){
      var tr = document.createElement('tr');
      tr.innerHTML = '<td style="padding:4px"><input type="text" class="input" value="'+name+'"></td>'+
                     '<td style="padding:4px"><input type="number" class="input mono" value="'+data[name]+'"></td>'+
                     '<td style="padding:4px;text-align:center"><button class="btn warn remove-item" type="button">Hapus</button></td>';
      tbody.appendChild(tr);
    });
    backdrop.hidden = false;
    modal.hidden = false;
    requestAnimationFrame(function(){
      backdrop.classList.add('is-visible');
      modal.classList.add('is-visible');
    });
    function onBackdropClick(e){ if(e.target === backdrop) hideModal(); }
    backdrop.addEventListener('click', onBackdropClick, { once: true });
  }
  function hideModal(){
    var modal = document.getElementById('jajananSettingsModal');
    var backdrop = document.getElementById('popupBackdrop');
    backdrop.classList.remove('is-visible');
    modal.classList.remove('is-visible');
    setTimeout(function(){
      backdrop.hidden = true;
      modal.hidden = true;
    },200);
  }
  var __jajBtn = document.getElementById('jajananSettingsBtn');
  if(__jajBtn){ __jajBtn.addEventListener('click', showJajananSettingsModal); }
  window.showJajananSettingsModal = showJajananSettingsModal;
  document.querySelector('#jajananSettingsModal [data-close]').addEventListener('click', hideModal);
  document.querySelector('#jajananSettingsModal [data-cancel]').addEventListener('click', hideModal);
  document.getElementById('addJajananItemBtn').addEventListener('click', function(){
    var tbody = document.querySelector('#jajananSettingsTable tbody');
    var tr = document.createElement('tr');
    tr.innerHTML = '<td style="padding:4px"><input type="text" class="input" placeholder="Nama Jajanan"></td>'+
                   '<td style="padding:4px"><input type="number" class="input mono" placeholder="Harga"></td>'+
                   '<td style="padding:4px;text-align:center"><button class="btn warn remove-item" type="button">Hapus</button></td>';
    tbody.appendChild(tr);
  });
  document.querySelector('#jajananSettingsTable').addEventListener('click', function(e){
    if(e.target.classList.contains('remove-item')){
      e.target.closest('tr').remove();
    }
  });
  document.getElementById('saveJajananSettingsBtn').addEventListener('click', function(){
    var tbody = document.querySelector('#jajananSettingsTable tbody');
    var newData = {};
    tbody.querySelectorAll('tr').forEach(function(tr){
      var name = tr.querySelector('td:nth-child(1) input').value.trim();
      var price = parseInt(tr.querySelector('td:nth-child(2) input').value)||0;
      if(name) newData[name] = price;
    });
    saveJajananSettings(newData);
    hideModal();
    buildJajanan3x10();
  });
  // Override buildJajanan3x10 to use saved settings
  var originalBuildJajanan3x10 = buildJajanan3x10;
  buildJajanan3x10 = function(){
    JAJ_PRICE = loadJajananSettings();
    var tb = document.querySelector('#jajananTable3x10 tbody'); tb.innerHTML='';
    var items = Object.keys(JAJ_PRICE);
    for(var i=0;i<5;i++){
      var tr=document.createElement('tr');
      tr.innerHTML = '<td>'+(i+1)+'</td>' +
        '<td><select class="select mini j3-jenis"><option value="">-</option>'+items.map(x=>'<option>'+x+'</option>').join('')+'</select></td>' +
        '<td><input type="number" min="0" step="1" placeholder="0" class="input mono mini j3-qty"/></td>' +
        '<td><input type="time" class="input mini j3-jam"/></td>' +
        '<td><input type="number" min="0" step="100" placeholder="0" readonly class="input mono mini j3-harga"/></td>';
      tb.appendChild(tr);
    }
    document.querySelectorAll('#jajananTable3x10 tbody tr').forEach(function(tr){
      var sel=tr.querySelector('.j3-jenis'), qty=tr.querySelector('.j3-qty'), harga=tr.querySelector('.j3-harga');
      function recalc(){ var unit=JAJ_PRICE[sel.value]||0; var q=parseInt(qty.value)||0; harga.value=unit*q; sumJajanan3x10(); }
      sel.addEventListener('change', recalc); qty.addEventListener('input', recalc);
    });
  };
})();
    // ===== Helpers
    function $(sel){ return document.querySelector(sel); }
    function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
    function ID(){ return Math.random().toString(36).slice(2,9); }
    function cleanNum(v){ var n=parseInt(v,10); if(isNaN(n)||!isFinite(n)||n<0) n=0; return n; }
    function monthKey(d){ return (d||'').slice(0,7); }
    function todayStr(){ var o=(new Date()).getTimezoneOffset(); var d=new Date(Date.now()-o*60000); return d.toISOString().slice(0,10); }
    function fmtIDR(n){ try { return (n||0).toLocaleString('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}); } catch(e){ return 'Rp '+String(n||0).replace(/\\B(?=(\\d{3})+(?!\\d))/g,'.'); } }


    function setRangeControlsEnabled(isRange){
      var ids = ['dateFrom','dateTo','rangeApply','rangeClear'];
      ids.forEach(function(id){
        var el = document.getElementById(id);
        if(!el) return;
        el.disabled = !isRange;
        el.style.opacity = isRange ? '1' : '0.5';
      });
      if(!isRange){
        var from = document.getElementById('dateFrom');
        var to   = document.getElementById('dateTo');
        if(from) from.value = '';
        if(to)   to.value = '';
        if(window.state) window.state.range = null;
      }
    }
    // ===== Theme Toggle (persist)
    var THEME_KEY = 'urban_ps_theme';
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t==='light' ? 'light' : null);
      var btn = $('#themeBtn');
      if(btn){ btn.textContent = (t==='light') ? '‚òÄÔ∏è Terang' : 'üåô Gelap'; }
    }
    function getTheme(){ try{ return localStorage.getItem(THEME_KEY)||'dark'; }catch(e){ return 'dark'; } }
    function setTheme(t){ try{ localStorage.setItem(THEME_KEY,t); }catch(e){} applyTheme(t); }
    $('#themeBtn').addEventListener('click', function(){
      var cur = getTheme();
      setTheme(cur==='light' ? 'dark' : 'light');
    });
    applyTheme(getTheme());

    // ===== State & Persistence
    var state = { entries:[], filter:'ALL', range:null, editingId:null };
    function save(){ try{ localStorage.setItem('urban_ps_pembukuan', JSON.stringify(state.entries)); }catch(e){} }
    function load(){ try{ state.entries = JSON.parse(localStorage.getItem('urban_ps_pembukuan')||'[]'); }catch(e){ state.entries=[]; } }

    // ===== Build Month Filter
    function prettyMonth(ym){ var p=ym.split('-'); var d=new Date(+p[0],+p[1]-1,1); try{ return d.toLocaleDateString('id-ID',{month:'long',year:'numeric'}); }catch(e){ return ym; } }
    function buildMonthFilter(){
      var sel=$('#monthFilter'); var map={}, months=[];
      for(var i=0;i<state.entries.length;i++){ 
        var mk=monthKey(state.entries[i].date); 
        if(mk && !map[mk]){ map[mk]=1; months.push(mk); } 
      }
      months.sort(); sel.innerHTML='';
      var optAll=document.createElement('option'); 
      optAll.value='ALL'; 
      optAll.textContent='Semua Bulan'; 
      sel.appendChild(optAll);

      for(var j=0;j<months.length;j++){ 
        var o=document.createElement('option'); 
        o.value=months[j]; 
        o.textContent=prettyMonth(months[j]); 
        sel.appendChild(o); 
      }

      // Append Rentang option at the bottom
      var optRange=document.createElement('option'); 
      optRange.value='RENTANG'; 
      optRange.textContent='Rentang'; 
      sel.appendChild(optRange);

      sel.value=state.filter;
      // Append Rentang option
    }

    function filtered(){
      var list;
      if (state.filter === 'ALL') {
        list = state.entries.slice();
      } else if (state.filter === 'RENTANG') {
        // If no range selected, return empty list immediately
        if (!state.range || (!state.range.from && !state.range.to)) {
          return [];
        }
        list = state.entries.slice();
      } else {
        list = state.entries.filter(function(e){ return monthKey(e.date) === state.filter; });
      }

      if (state.filter === 'RENTANG' && state.range && (state.range.from || state.range.to)) {
        var from = state.range.from || '0000-01-01';
        var to   = state.range.to   || '9999-12-31';
        list = list.filter(function(e){
          var d = e.date || '';
          return d && d >= from && d <= to;
        });
      }

      return list;
    }
    function calcSums(list){
      var s={harian:0,jajanan:0,jasa:0,sewa:0,total:0};
      list.forEach(function(e){ s.harian+=cleanNum(e.harian); s.jajanan+=cleanNum(e.jajanan); s.jasa+=cleanNum(e.jasa); s.sewa+=cleanNum(e.sewa); });
      s.total=s.harian+s.jajanan+s.jasa+s.sewa; return s;
    }

    // ===== Grand Total live
    window.sumGrandLive = function(){
      var g = cleanNum($('#harian').value)+cleanNum($('#jajanan').value)+cleanNum($('#jasa').value)+cleanNum($('#sewa').value);
      $('#grandTotal').textContent = fmtIDR(g); updateRecap();
    };


    function getDayName(dateStr){
      if(!dateStr) return "-";
      try {
        var opts = { weekday: 'long' };
        return new Date(dateStr).toLocaleDateString('id-ID', opts);
      } catch(e){ return "-"; }
    }

    function updateRecap(){
      var fmt = fmtIDR;
      var h = cleanNum($('#harian').value);
      var j = cleanNum($('#jajanan').value);
      var ja = cleanNum($('#jasa').value);
      var s = cleanNum($('#sewa').value);
      var _h=$('#recapHarian'), _j=$('#recapJajanan'), _ja=$('#recapJasa'), _s=$('#recapSewa');
      if(_h) _h.textContent = fmt(h);
      if(_j) _j.textContent = fmt(j);
      if(_ja) _ja.textContent = fmt(ja);
      if(_s) _s.textContent = fmt(s);
    }

function scrollToTopMobile() {
  try {
    if (document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
  } catch(e) {}
  var header = document.querySelector('.header');
  if (header && header.scrollIntoView) {
    try { header.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e) {}
  }
  var root = document.scrollingElement || document.documentElement || document.body;
  if (root && root.scrollTo) {
    try { root.scrollTo(0, 0); } catch(e) {}
    requestAnimationFrame(function(){
      setTimeout(function(){
        try { root.scrollTo({ top: 0, behavior: 'smooth' }); } catch(e) { try { root.scrollTop = 0; } catch(_) {} }
      }, 80);
    });
  } else {
    try { document.documentElement.scrollTop = 0; document.body.scrollTop = 0; } catch(e) {}
  }
}


    // ====== Tables builders & sum
    // RINCIAN HARIAN
    var rincianBody = $('#rincianTable tbody');
    var RENTAL_RATE = { PS3:{hour:5000,half:3000}, PS4:{hour:7000,half:4000} };
    function hitungHarga(ps,jumlah){
      if(!ps) return 0; var r=RENTAL_RATE[ps]; if(!r) return 0;
      var n=parseFloat(jumlah); if(isNaN(n)||!isFinite(n)||n<=0) return 0;
      var whole=Math.floor(n); var rem=Math.round((n-whole)*10)/10; var total=whole*r.hour;
      if(Math.abs(rem-0.5)<0.001) total+=r.half; else if(rem>0) total+=Math.round(rem*r.hour);
      return total;
    }
    function buildRincianRows(){
      rincianBody.innerHTML='';
      for(var i=1;i<=10;i++){
        var tr=document.createElement('tr');
        tr.innerHTML = '<td>'+i+'</td>' +
          '<td><select class="select mini r-jenis"><option value="">-</option><option>PS3</option><option>PS4</option></select></td>' +
          '<td><input type="time" class="input mini r-jam"/></td>' +
          '<td><input type="number" min="0" step="0.5" placeholder="0" class="input mono mini r-jumlah"/></td>' +
          '<td><input type="number" min="0" step="100" placeholder="0" class="input mono mini rincian-harga r-harga"/></td>';
        rincianBody.appendChild(tr);
      }
      wireRincianEvents();
    }
    function sumRincian(){
      var sum=0; $all('.rincian-harga').forEach(function(inp){ sum+=cleanNum(inp.value); });
      $('#rincianTotal').textContent=fmtIDR(sum); $('#harian').value=sum; if(window.sumGrandLive) window.sumGrandLive(); updateRecap(); updateRecap();
    }
    function wireRincianEvents(){
      $all('#rincianTable tbody tr').forEach(function(tr){
        var sel = tr.querySelector('.r-jenis'); var j = tr.querySelector('.r-jumlah'); var h = tr.querySelector('.r-harga');
        function recalc(){ var harga=hitungHarga(sel.value,j.value); h.value=harga?String(harga):''; sumRincian(); }
        sel.addEventListener('change', recalc); j.addEventListener('input', recalc);
      });
      $all('.r-harga').forEach(function(inp){ inp.addEventListener('input', sumRincian); });
    }
    $('#rincianClear').addEventListener('click', function(){ $all('#rincianTable input').forEach(function(i){ i.value=''; }); sumRincian(); });

    // JAJANAN 3x10 (5 rows)
    var JAJ_PRICE = {
      "Kopi Panas Original":3000,"Teh Panas":3000,"Es Teh":3000,"Kopi Kapal Api":3000,
      "GoodDay Capuchino Panas":4000,"GoodDay Capuchino Dingin":5000,
      "Luwak White Cofee Panas":4000,"Luwak White Cofee Dingin":5000,
      "Torabika Moka Panas":4000,"Torabika Moka Dingin":5000,
      "Marimas":2000,"Nutrisari":3000,
      "Mie Pakai Telor (Free Nasi)":10000,"Mie Tanpa Telor (Free Nasi)":7000,"Pop Mie (Free Nasi)":8000
    };
    function buildJajanan3x10(){
      var tb = $('#jajananTable3x10 tbody'); tb.innerHTML='';
      var items=Object.keys(JAJ_PRICE);
      for(var i=0;i<5;i++){
        var tr=document.createElement('tr');
        tr.innerHTML = '<td>'+(i+1)+'</td>' +
          '<td><select class="select mini j3-jenis"><option value="">-</option>'+items.map(x=>'<option>'+x+'</option>').join('')+'</select></td>' +
          '<td><div style="display:grid;grid-template-columns:1fr 1fr;gap: var(--space-1)">' +
              '<input type="number" min="0" step="1" placeholder="0" class="input mono mini j3-qty"/>' +
              '<input type="time" class="input mini j3-jam"/></div></td>' +
          '<td><input type="number" min="0" step="100" placeholder="0" readonly class="input mono mini j3-harga"/></td>';
        tb.appendChild(tr);
      }
      $all('#jajananTable3x10 tbody tr').forEach(function(tr){
        var sel=tr.querySelector('.j3-jenis'), qty=tr.querySelector('.j3-qty'), harga=tr.querySelector('.j3-harga');
        function recalc(){ var unit=JAJ_PRICE[sel.value]||0; var q=cleanNum(qty.value); harga.value=unit*q; sumJajanan3x10(); }
        sel.addEventListener('change', recalc); qty.addEventListener('input', recalc);
      });
    }
    function sumJajanan3x10(){
      var tot=0; $all('.j3-harga').forEach(function(i){ tot+=cleanNum(i.value); });
      $('#jajananTotal3x10').textContent=fmtIDR(tot); $('#jajanan').value=tot; if(window.sumGrandLive) window.sumGrandLive(); updateRecap(); updateRecap();
    }
    document.addEventListener('click', function(e){ if(e.target && e.target.id==='jajanan3x10Clear'){ $all('#jajananTable3x10 input, #jajananTable3x10 select').forEach(function(i){ i.value=''; }); sumJajanan3x10(); } });

    // JASA 2x5
    var JASA_TYPES=["Isi Game","Stik & Aksesoris","Upgrade HEN","Aksesoris"];
    function buildJasa2x5(){
      var tb=$('#jasaTable2x5 tbody'); tb.innerHTML='';
      for(var i=0;i<5;i++){
        var tr=document.createElement('tr');
        tr.innerHTML = '<td>'+ (i+1) +'</td>' +
          '<td><select class="select mini jasa-type"><option value="">-</option>'+JASA_TYPES.map(x=>'<option>'+x+'</option>').join('')+'</select></td>' +
          '<td><input type="text" class="input mini jasa-note" placeholder="keterangan (opsional)"/></td>' +
          '<td><input type="number" min="0" step="100" placeholder="0" class="input mono mini jasa-price"/></td>';
        tb.appendChild(tr);
      }
      $all('.jasa-price').forEach(function(inp){ inp.addEventListener('input', sumJasa2x5); });
    }
    function sumJasa2x5(){
      var tot=0; $all('.jasa-price').forEach(function(i){ tot+=cleanNum(i.value); });
      $('#jasaTotal2x5').textContent=fmtIDR(tot); $('#jasa').value=tot; if(window.sumGrandLive) window.sumGrandLive(); updateRecap(); updateRecap();
    }
    document.addEventListener('click', function(e){ if(e.target && e.target.id==='jasa2x5Clear'){ $all('#jasaTable2x5 input, #jasaTable2x5 select').forEach(function(i){ i.value=''; }); sumJasa2x5(); } });

    // SEWA 3x10 (5 rows)
    var SEWA_TYPES=["PS3","PS4","PS3 + TV","PS4 + TV","PS3 Portable","PS4 Portable","Hanya TV"];
    var SEWA_RATES={ "PS3":{h12:40000,h24:70000},"PS4":{h12:80000,h24:140000},"PS3 + TV":{h12:60000,h24:100000},"PS4 + TV":{h12:100000,h24:170000},"PS3 Portable":{h12:60000,h24:100000},"PS4 Portable":{h12:100000,h24:170000},"Hanya TV":{h12:30000,h24:50000} };
    function hoursFromDurasiSelect(selVal, manualVal){
      var mv=parseFloat(manualVal); if(!isNaN(mv) && isFinite(mv) && mv>0) return mv;
      switch(selVal){ case '12JAM':return 12; case '1HARI':return 24; case '2HARI':return 48; case '3HARI':return 72; default:return 0; }
    }
    function calcSewaPrice(type,hours){
      var r=SEWA_RATES[type]; if(!r||!hours||hours<=0) return 0;
      if(hours<=12) return r.h12; if(hours<=24) return r.h24; var days=Math.ceil(hours/24); return days*r.h24;
    }
    function buildSewa3x10(){
      var tb=$('#sewaTable3x10 tbody'); tb.innerHTML='';
      for(var i=0;i<5;i++){
        var tr=document.createElement('tr');
        tr.innerHTML = '<td>'+(i+1)+'</td>' +
          '<td><select class="select mini sewa-jenis"><option value="">-</option>'+SEWA_TYPES.map(x=>'<option>'+x+'</option>').join('')+'</select></td>' +
          '<td><div style="display:grid;grid-template-columns:1fr 1fr;gap: var(--space-1)">' +
              '<select class="select mini sewa-durasi"><option value="">-</option><option value="12JAM">12 JAM</option><option value="1HARI">1 HARI</option><option value="2HARI">2 HARI</option><option value="3HARI">3 HARI</option></select>' +
              '<input type="text" placeholder="Isi Sendiri" class="input mini sewa-manual"/></div></td>' +
          '<td><input type="text" placeholder="note (optional)" class="input mini sewa-lama-note"/></td><td><input type="number" min="0" step="1000" placeholder="0" class="input mono mini sewa-harga"/></td>';
        tb.appendChild(tr);
      }
      $all('#sewaTable3x10 tbody tr').forEach(function(tr){
        var selJ=tr.querySelector('.sewa-jenis'); var selD=tr.querySelector('.sewa-durasi'); var inM=tr.querySelector('.sewa-manual'); var inH=tr.querySelector('.sewa-harga');
        function recalc(){
  var manualVal = (inM.value || '').trim();
  if(manualVal){
    // User filled 'Isi Sendiri', skip auto calculation entirely
    return;
  }
  var jam = hoursFromDurasiSelect(selD.value, '');
  var price = calcSewaPrice(selJ.value, jam);
  if(price>0){ inH.value = price; }
  else { inH.value=''; }
  sumSewa3x10();
}
        selJ.addEventListener('change', recalc); selD.addEventListener('change', recalc); inM.addEventListener('input', recalc); inH.addEventListener('input', sumSewa3x10);
      });
    }
    function sumSewa3x10(){
      var tot=0; $all('.sewa-harga').forEach(function(i){ tot+=cleanNum(i.value); });
      $('#sewaTotal3x10').textContent=fmtIDR(tot); $('#sewa').value=tot; if(window.sumGrandLive) window.sumGrandLive(); updateRecap(); updateRecap();
    }
    document.addEventListener('click', function(e){ if(e.target && e.target.id==='sewa3x10Clear'){ $all('#sewaTable3x10 input, #sewaTable3x10 select').forEach(function(i){ i.value=''; }); sumSewa3x10(); } });

    // ===== Serialize details
    function collectDetails(){
      var rincian = $all('#rincianTable tbody tr').map(function(tr){
        return {
          jenis: tr.querySelector('.r-jenis').value || '',
          jam: tr.querySelector('.r-jam').value || '',
          jumlah: tr.querySelector('.r-jumlah').value || '',
          harga: cleanNum(tr.querySelector('.r-harga').value)
        };
      });
      var jajanan = $all('#jajananTable3x10 tbody tr').map(function(tr){
        return {
          jenis: tr.querySelector('.j3-jenis').value || '',
          qty: cleanNum(tr.querySelector('.j3-qty').value),
          jam: tr.querySelector('.j3-jam').value || '',
          harga: cleanNum(tr.querySelector('.j3-harga').value)
        };
      });
      var jasa = $all('#jasaTable2x5 tbody tr').map(function(tr){
        return {
          tipe: tr.querySelector('.jasa-type').value || '',
          ket: (tr.querySelector('.jasa-note') && tr.querySelector('.jasa-note').value) || '',
          harga: cleanNum(tr.querySelector('.jasa-price').value)
        };
      });
      var sewa = $all('#sewaTable3x10 tbody tr').map(function(tr){
  return {
    jenis: tr.querySelector('.sewa-jenis').value || '',
    durasi: tr.querySelector('.sewa-durasi').value || '',
    manualJam: tr.querySelector('.sewa-manual').value || '',
    lamaNote: (tr.querySelector('.sewa-lama-note') && tr.querySelector('.sewa-lama-note').value) || '',
    harga: cleanNum(tr.querySelector('.sewa-harga').value)
  };
});
      return { rincian:rincian, jajanan3x10:jajanan, jasa2x5:jasa, sewa3x10:sewa };
    }


    // ===== Validation helpers
    function detailsIsEmpty(det){
      det = det || collectDetails();
      function anyIn(arr, keys){
        if(!arr) return false;
        for(var i=0;i<arr.length;i++){
          var o = arr[i] || {};
          for(var k=0;k<keys.length;k++){
            var v = o[keys[k]];
            if(typeof v === 'number' && v > 0) return true;
            if(typeof v === 'string' && String(v).trim() !== '') return true;
          }
        }
        return false;
      }
      // If any detail field has content/value, not empty
      if(anyIn(det.rincian, ['jenis','jam','jumlah','harga'])) return false;
      if(anyIn(det.jajanan3x10, ['jenis','qty','jam','harga'])) return false;
      if(anyIn(det.jasa2x5, ['tipe','ket','harga'])) return false;
      if(anyIn(det.sewa3x10, ['jenis','durasi','manualJam','lamaNote','harga'])) return false;
      return true;
    }
    function formIsTrulyEmpty(){
      var h = cleanNum($('#harian').value);
      var j = cleanNum($('#jajanan').value);
      var ja = cleanNum($('#jasa').value);
      var s = cleanNum($('#sewa').value);
      var cat = ($('#catatan').value||'').trim();
      // Consider "empty" if all numeric incomes are zero AND no detail inputs filled.
      // Catatan alone does not count as data.
      var det = collectDetails();
      return (h + j + ja + s === 0) && detailsIsEmpty(det);
    }

    // ===== Apply details
    function applyDetails(det){
      det = det || {};
      $all('#rincianTable tbody tr').forEach(function(tr,idx){
        var d = (det.rincian && det.rincian[idx]) || {};
        tr.querySelector('.r-jenis').value = d.jenis || '';
        tr.querySelector('.r-jam').value = d.jam || '';
        tr.querySelector('.r-jumlah').value = d.jumlah || '';
        tr.querySelector('.r-harga').value = d.harga || '';
      });
      sumRincian();
      $all('#jajananTable3x10 tbody tr').forEach(function(tr,idx){
        var d = (det.jajanan3x10 && det.jajanan3x10[idx]) || {};
        tr.querySelector('.j3-jenis').value = d.jenis || '';
        tr.querySelector('.j3-qty').value = d.qty || '';
        tr.querySelector('.j3-jam').value = d.jam || '';
        tr.querySelector('.j3-harga').value = d.harga || '';
      });
      sumJajanan3x10();
      $all('#jasaTable2x5 tbody tr').forEach(function(tr,idx){
        var d = (det.jasa2x5 && det.jasa2x5[idx]) || {};
        tr.querySelector('.jasa-type').value = d.tipe || '';
        var note = tr.querySelector('.jasa-note'); if(note) note.value = d.ket || '';
        tr.querySelector('.jasa-price').value = d.harga || '';
      });
      sumJasa2x5();
      $all('#sewaTable3x10 tbody tr').forEach(function(tr,idx){
  var d = (det.sewa3x10 && det.sewa3x10[idx]) || {};
  tr.querySelector('.sewa-jenis').value = d.jenis || '';
  tr.querySelector('.sewa-durasi').value = d.durasi || '';
  tr.querySelector('.sewa-manual').value = d.manualJam || '';
  var note = d.lamaNote || '';
  var noteEl = tr.querySelector('.sewa-lama-note'); if(noteEl) noteEl.value = note;
  tr.querySelector('.sewa-harga').value = d.harga || '';
});
sumSewa3x10();
      if(window.sumGrandLive) window.sumGrandLive(); updateRecap();
      try{ drawDailyGraph(); }catch(e){ /* ignore */ }
    }

    // ===== Inline editable cells
    function editableMoneyCell(value, onCommit){
      var span=document.createElement('span');
      span.textContent=fmtIDR(cleanNum(value));
      span.style.cursor='pointer'; span.title='Klik untuk ubah';
      span.addEventListener('click', function(){
        var input=document.createElement('input');
        input.type='number'; input.className='input mono'; input.style.padding='6px 8px'; input.value=cleanNum(value);
        span.parentNode.replaceChild(input, span);
        input.focus();
        var commit=function(){ onCommit(cleanNum(input.value)); };
        input.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); commit(); }});
        input.addEventListener('blur', commit);
      });
      return span;
    }
    function editableTextCell(value, onCommit){
      var span=document.createElement('span'); span.textContent=value||''; span.style.cursor='pointer'; span.title='Klik untuk ubah';
      span.addEventListener('click', function(){
        var input=document.createElement('textarea'); input.className='input'; input.rows=2; input.value=value||'';
        span.parentNode.replaceChild(input, span); input.focus();
        var commit=function(){ onCommit(String(input.value||'')); };
        input.addEventListener('keydown', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); commit(); }});
        input.addEventListener('blur', commit);
      });
      return span;
    }
    function editableDateCell(value, onCommit){
      var span=document.createElement('span'); span.textContent=value||todayStr(); span.style.cursor='pointer'; span.title='Klik untuk ubah';
      span.addEventListener('click', function(){
        var input=document.createElement('input'); input.type='date'; input.className='input'; input.value=value||todayStr();
        span.parentNode.replaceChild(input, span); input.focus();
        var commit=function(){ onCommit(input.value||todayStr()); };
        input.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); commit(); }});
        input.addEventListener('blur', commit);
      });
      return span;
    }

    // ===== Render main table
    function render(){
      buildMonthFilter();
      var list=filtered().sort(function(a,b){ return (a.date>b.date?1:-1); });
      var tbody=$('#table tbody'); tbody.innerHTML='';
      list.forEach(function(e){
        var tr=document.createElement('tr');
        var tds=[
          (function(){ var td=document.createElement('td'); td.textContent = e.date; return td; })(),
          (function(){ var td=document.createElement('td'); td.textContent=getDayName(e.date); return td; })(),
          (function(){ var td=document.createElement('td'); td.className='mono right'; td.textContent = fmtIDR(e.harian); return td; })(),
          (function(){ var td=document.createElement('td'); td.className='mono right'; td.textContent = fmtIDR(e.jajanan); return td; })(),
          (function(){ var td=document.createElement('td'); td.className='mono right'; td.textContent = fmtIDR(e.jasa); return td; })(),
          (function(){ var td=document.createElement('td'); td.className='mono right'; td.textContent = fmtIDR(e.sewa); return td; })(),
          (function(){ var td=document.createElement('td'); td.className='mono right'; var tot=cleanNum(e.harian)+cleanNum(e.jajanan)+cleanNum(e.jasa)+cleanNum(e.sewa); td.textContent=fmtIDR(tot); return td; })(),
          (function(){ var td=document.createElement('td'); td.textContent = e.catatan || ''; return td; })(),
          (function(){
            var td=document.createElement('td'); td.className='right';
            var edit=document.createElement('button'); edit.className='btn'; edit.textContent='Edit'; edit.title='Load rincian ke form atas';
            edit.onclick=function(){
              // Load this entry into the form + detail tables
              state.editingId = e.id;
              $('#addBtn').textContent = 'Simpan Perubahan'; document.getElementById('cancelEditBtn').style.display='inline-block';
              $('#date').value = e.date || todayStr();
              $('#harian').value = cleanNum(e.harian);
              $('#jajanan').value = cleanNum(e.jajanan);
              $('#jasa').value = cleanNum(e.jasa);
              $('#sewa').value = cleanNum(e.sewa);
              $('#catatan').value = e.catatan || '';
              $('#absenPagi').value = e.absenPagi || '';
              $('#absenSiang').value = e.absenSiang || '';
              $('#rukoBuka').value = e.rukoBuka || '';
              $('#rukoTutup').value = e.rukoTutup || '';
              applyDetails(e.details || null);

    // Update field Hari setelah tanggal di-set
    if (typeof updateDayField === "function") {
        updateDayField();
    }
var actionsRow = document.getElementById('formActions');
if(actionsRow) actionsRow.classList.add('editing');
if(window.sumGrandLive) window.sumGrandLive(); updateRecap();
scrollToTopMobile();
              };
            td.appendChild(edit);
            var sp=document.createElement('span'); sp.style.display='inline-block'; sp.style.width='6px'; td.appendChild(sp);
            var del=document.createElement('button'); del.className='btn warn'; del.textContent='Hapus'; del.title='Hapus baris ini';
            del.onclick = async function(){ if(await themedConfirm('Hapus baris ini?')){ state.entries = state.entries.filter(function(it){ return it!==e; }); save(); render(); } };
            td.appendChild(del); return td;
          })()
        ];
        tds.forEach(function(td){ tr.appendChild(td); }); tbody.appendChild(tr);
      });
      var sums=calcSums(list);
      $('#sumHarian').textContent=fmtIDR(sums.harian);
      $('#sumJajanan').textContent=fmtIDR(sums.jajanan);
      $('#sumJasa').textContent=fmtIDR(sums.jasa);
      $('#sumSewa').textContent=fmtIDR(sums.sewa);
      $('#sumTotal').textContent=fmtIDR(sums.total);

      var monthList = [];
    var monthSum;
if (state.filter === 'RENTANG' && state.range && (state.range.from || state.range.to)) {
    var from = state.range.from || '0000-01-01';
    var to   = state.range.to   || '9999-12-31';
    var rangeList = state.entries.filter(function(e){
        var d = e.date || '';
        return d && d >= from && d <= to;
    });
    monthSum = calcSums(rangeList).total;
} else {
    var monthPick = (state.filter==='ALL') ? monthKey(todayStr()) : state.filter;
    var monthList = state.entries.filter(function(x){ return monthKey(x.date)===monthPick; });
    monthSum = calcSums(monthList).total;
} var allSum=calcSums(state.entries).total;
      var _mt=$('#monthTotal'); if(_mt) _mt.textContent=fmtIDR(monthSum); var _at=$('#allTotal'); if(_at) _at.textContent=fmtIDR(allSum);
      // Fill new footer cells inside History
      var sm=document.getElementById('sumMonth'); if(sm) sm.textContent = fmtIDR(monthSum);
      var sa=document.getElementById('sumAll'); if(sa) sa.textContent = fmtIDR(allSum);

// === Custom Footer Logic ===
(function(){
    var smEl = document.getElementById('sumMonth');
    var saRow = null;
    document.querySelectorAll('#table tfoot tr').forEach(function(tr){
        if(tr.textContent.trim().toLowerCase().includes('total semua')){
            saRow = tr;
        }
    });
    // Reset visibility
    if(saRow) saRow.style.display = '';
    if(smEl){
        var labelCell = smEl.closest('tr').querySelector('td[colspan="6"]');
        if(labelCell) labelCell.textContent = 'Total Bulan Ini';
    }

    if(state.filter === 'RENTANG'){
        if(state.range && (state.range.from || state.range.to)){
            var from = state.range.from || '0000-01-01';
            var to   = state.range.to   || '9999-12-31';
            var rangeList = state.entries.filter(function(e){
                var d = e.date || '';
                return d && d >= from && d <= to;
            });
            var rangeSum = calcSums(rangeList).total;
            if(smEl) smEl.textContent = fmtIDR(rangeSum);
        }
        if(smEl){
            var labelCell = smEl.closest('tr').querySelector('td[colspan="6"]');
            if(labelCell) labelCell.textContent = 'Total Rentang';
        }
        if(saRow) saRow.style.display = 'none';
    } else if(state.filter !== 'ALL'){
        // Filter bulan: sembunyikan Total Semua
        if(saRow) saRow.style.display = 'none';
    }
})();

      var totalLabelEl = document.querySelector('#table tfoot tr.total-row td[colspan="5"]');
      if (totalLabelEl) {
        totalLabelEl.textContent = (state.filter === 'RENTANG') ? 'Total rentang' : 'Total bulan ini';
      }

      // Per-column month sums
      var monthCols = calcSums(monthList);
      var allCols = calcSums(state.entries);
      var mapIds = {
        'sumHarianMonth': monthCols.harian,
        'sumJajananMonth': monthCols.jajanan,
        'sumJasaMonth': monthCols.jasa,
        'sumSewaMonth': monthCols.sewa,
        'sumHarianAll': allCols.harian,
        'sumJajananAll': allCols.jajanan,
        'sumJasaAll': allCols.jasa,
        'sumSewaAll': allCols.sewa
      };
      Object.keys(mapIds).forEach(function(id){
        var el = document.getElementById(id);
        if(el){ el.textContent = fmtIDR(mapIds[id]); }
      });

      var sm=document.getElementById('sumMonth'); if(sm) sm.textContent = fmtIDR(monthSum);
      var sa=document.getElementById('sumAll'); if(sa) sa.textContent = fmtIDR(allSum);

// === Custom Footer Logic ===
(function(){
    var smEl = document.getElementById('sumMonth');
    var saRow = null;
    document.querySelectorAll('#table tfoot tr').forEach(function(tr){
        if(tr.textContent.trim().toLowerCase().includes('total semua')){
            saRow = tr;
        }
    });
    // Reset visibility
    if(saRow) saRow.style.display = '';
    if(smEl){
        var labelCell = smEl.closest('tr').querySelector('td[colspan="6"]');
        if(labelCell) labelCell.textContent = 'Total Bulan Ini';
    }

    if(state.filter === 'RENTANG'){
        if(state.range && (state.range.from || state.range.to)){
            var from = state.range.from || '0000-01-01';
            var to   = state.range.to   || '9999-12-31';
            var rangeList = state.entries.filter(function(e){
                var d = e.date || '';
                return d && d >= from && d <= to;
            });
            var rangeSum = calcSums(rangeList).total;
            if(smEl) smEl.textContent = fmtIDR(rangeSum);
        }
        if(smEl){
            var labelCell = smEl.closest('tr').querySelector('td[colspan="6"]');
            if(labelCell) labelCell.textContent = 'Total Rentang';
        }
        if(saRow) saRow.style.display = 'none';
    } else if(state.filter !== 'ALL'){
        // Filter bulan: sembunyikan Total Semua
        if(saRow) saRow.style.display = 'none';
    }
})();

      var totalLabelEl = document.querySelector('#table tfoot tr.total-row td[colspan="5"]');
      if (totalLabelEl) {
        totalLabelEl.textContent = (state.filter === 'RENTANG') ? 'Total rentang' : 'Total bulan ini';
      }

      if(window.sumGrandLive) window.sumGrandLive(); updateRecap();
      try{ drawDailyGraph(); }catch(e){ /* ignore */ }
    }

    // ===== Add or Update entry from form
    function entryFromForm(){
      return {
        id: state.editingId || ID(),
        date: $('#date').value || todayStr(),
        harian: cleanNum($('#harian').value),
        jajanan: cleanNum($('#jajanan').value),
        jasa: cleanNum($('#jasa').value),
        sewa: cleanNum($('#sewa').value),
        catatan: ($('#catatan').value||'').trim(),
        absenPagi: $('#absenPagi').value || '',
        absenSiang: $('#absenSiang').value || '',
        rukoBuka: $('#rukoBuka').value || '',
        rukoTutup: $('#rukoTutup').value || '',
        details: collectDetails()
      };
    }
    async function addOrUpdateEntry(){
      // Guard: don't save empty forms
      if(formIsTrulyEmpty()){
        await themedAlert('Form masih kosong. Isi setidaknya satu nilai atau rincian sebelum menyimpan.');
        return;
      }
      var newEntry = entryFromForm();
      if(state.editingId){
        var idx = state.entries.findIndex(function(x){ return x.id===state.editingId; });
        if(idx>=0) state.entries[idx] = newEntry;
state.editingId = null;
$('#addBtn').textContent = '+ Tambah Pencatatan';
document.getElementById('cancelEditBtn').style.display='none';
var actionsRow = document.getElementById('formActions');
if(actionsRow) actionsRow.classList.remove('editing');
      }else{
        state.entries.push(newEntry);
      }
      save(); clearForm(); render();
    }

    function clearForm(){
      ['harian','jajanan','jasa','sewa','catatan'].forEach(function(id){ var el=$('#'+id); if(el) el.value=''; });
            $all('#rincianTable .r-jenis').forEach(function(sel){ sel.value = ''; });
      $('#date').value=todayStr();
      ['absenPagi','absenSiang','rukoBuka','rukoTutup'].forEach(function(id){var el=document.getElementById(id); if(el) el.value='';});
      $all('#rincianTable input, #jajananTable3x10 input, #jajananTable3x10 select, #jasaTable2x5 input, #jasaTable2x5 select, #sewaTable3x10 input, #sewaTable3x10 select').forEach(function(i){ i.value=''; });
      $('#rincianTotal').textContent=fmtIDR(0); $('#jajananTotal3x10').textContent=fmtIDR(0); $('#jasaTotal2x5').textContent=fmtIDR(0); $('#sewaTotal3x10').textContent=fmtIDR(0);
      if(window.sumGrandLive) window.sumGrandLive(); updateRecap();
      try{ drawDailyGraph(); }catch(e){ /* ignore */ }
    }

    // ===== CSV (aggregates only)
    window.exportCSV = function(){
      var header=['tanggal','harian','jajanan','jasa_aksesoris','sewa_ps','total','catatan'];
      var rows=state.entries.map(function(e){
        var tot=cleanNum(e.harian)+cleanNum(e.jajanan)+cleanNum(e.jasa)+cleanNum(e.sewa);
        var cat=String(e.catatan||'').split('"').join("''");
        return [e.date,cleanNum(e.harian),cleanNum(e.jajanan),cleanNum(e.jasa),cleanNum(e.sewa),tot,cat].join(',');
      });
      var csv=[header.join(','),rows.join('\\n')].join('\\n');
      var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='pembukuan_rental_ps_'+Date.now()+'.csv'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(function(){ URL.revokeObjectURL(url); },1500);
    }
    function importCSV(file){
      var reader=new FileReader();
      reader.onload=async function(ev){
        var text=ev.target.result||''; var lines=text.split(/\\r?\\n/); if(lines.length<2){ await themedAlert('CSV kosong atau tidak valid.'); return; }
        for(var i=1;i<lines.length;i++){
          var line=lines[i]; if(!line) continue; var p=line.split(',');
          var obj={ id:ID(), date:(p[0]||'').trim(), harian:cleanNum(p[1]), jajanan:cleanNum(p[2]), jasa:cleanNum(p[3]), sewa:cleanNum(p[4]), catatan:(p[6]||'').trim(), details:null };
          if(obj.date){ state.entries.push(obj); }
        }
        save(); render();
      };
      reader.readAsText(file);
    }

    // ===== Screenshot (full page)
    function takeFullScreenshot(){
      var btn=$('#screenshotBtn'); var prev=btn?btn.style.visibility:''; if(btn) btn.style.visibility='hidden';
      var w=Math.max(document.documentElement.scrollWidth, document.body.scrollWidth);
      var h=Math.max(document.documentElement.scrollHeight, document.body.scrollHeight);
      window.scrollTo(0,0);
      html2canvas(document.body,{useCORS:true,backgroundColor:getComputedStyle(document.body).backgroundColor,windowWidth:w,windowHeight:h,scale:2}).then(function(canvas){
        var dataURL=canvas.toDataURL('image/png'); var a=document.createElement('a');
        var now=new Date(); var pad=function(n){return (n<10?'0':'')+n;}
        a.href=dataURL; a.download='screenshot_urban_ps_'+now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate())+'_'+pad(now.getHours())+pad(now.getMinutes())+pad(now.getSeconds())+'.png';
        document.body.appendChild(a); a.click(); a.remove(); if(btn) btn.style.visibility=prev;
      }).catch(async function(err){ if(btn) btn.style.visibility=prev; await themedAlert('Gagal screenshot: '+err.message); });
    }

    // ===== Events

// ===== Events (basic confirm, no animations, no custom modal)
document.getElementById('addBtn').addEventListener('click', async function(){
  try {
    if (typeof formIsTrulyEmpty === 'function' && formIsTrulyEmpty()) {
      await themedAlert('Form masih kosong. Isi setidaknya satu nilai atau rincian sebelum menyimpan.');
      return;
    }
    var ok = await themedConfirm('Apakah pembukuan sudah di-screenshot?\nJika tekan OK data akan disimpan.');
    if (ok) addOrUpdateEntry();
  } catch (err) {
    await themedAlert('Gagal menyimpan: ' + err.message);
  }
});

        ['harian','jajanan','jasa','sewa'].forEach(function(id){ $('#'+id).addEventListener('input', function(){ if(window.sumGrandLive) window.sumGrandLive(); updateRecap(); }); });
    ['harian','jajanan','jasa','sewa','catatan'].forEach(function(id){ $('#'+id).addEventListener('keydown', function(e){ if(e.key==='Enter'){ addOrUpdateEntry(); }}); });
    $('#monthFilter').addEventListener('change', function(e){
      state.filter=e.target.value;
      setRangeControlsEnabled(state.filter==='RENTANG');
      render();
    setRangeControlsEnabled(state.filter==='RENTANG');
    });
    
    
    $('#clearBtn').addEventListener('click', async function(){
  // Password + confirm flow (theme-matched modal)
  const ADMIN_PASSWORD = '707426';
  var pwd = await themedPromptPassword({
    title: 'Verifikasi Hapus Data',
    placeholder: 'Password admin'
  });
  if (pwd === null) return; // closed/cancelled
  if (pwd !== ADMIN_PASSWORD){
    await themedAlert('Password salah. Aksi dibatalkan.');
    return;
  }
  if (await themedConfirm('Hapus SEMUA data?')){
    state.entries = [];
    save();
    render();
    setRangeControlsEnabled(state.filter==='RENTANG');
    await themedAlert('Semua data dihapus.');
  }
});
    
document.addEventListener('click', function(e){
    if(e.target && e.target.id === 'exportReportBtn'){
        exportReportPDF();
    }
});


// Ubah label tombol
document.getElementById('exportReportBtn').textContent = "üìù Download Laporan";

document.getElementById('exportReportBtn').addEventListener('click', function(){
    exportReportPDF();
});


async function exportReportPDF(){
    try {
        const { jsPDF } = window.jspdf;
        var w = Math.max(document.documentElement.scrollWidth, document.body.scrollWidth);
        var h = Math.max(document.documentElement.scrollHeight, document.body.scrollHeight);
        window.scrollTo(0,0);

        const canvas = await html2canvas(document.body, {
            useCORS: true,
            backgroundColor: getComputedStyle(document.body).backgroundColor,
            windowWidth: w,
            windowHeight: h,
            scale: 1.2
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.85);
        const pdf = new jsPDF('p', 'pt', [canvas.width * 0.75, canvas.height * 0.75]);
        pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width * 0.75, canvas.height * 0.75);

        // Ambil dari field input form
        const tanggalInput = document.getElementById('date').value;
        const hariInput = document.getElementById('day').value || '';

        let fileName;
        if (tanggalInput) {
            fileName = `pembukuan_URBAN_LPG_${tanggalInput}_${hariInput}.pdf`;
        } else {
            const today = new Date();
            const tanggal = today.toISOString().slice(0,10);
            const hari = today.toLocaleDateString('id-ID', { weekday: 'long' });
            fileName = `pembukuan_URBAN_LPG_${tanggal}_${hari}.pdf`;
        }

        const pdfBlob = pdf.output('blob');
        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

        // ==== Jika Web Share API tersedia ‚Üí langsung share ====
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
                title: "Laporan Pembukuan",
                text: "Berikut laporan pembukuan dalam format PDF.",
                files: [file]
            }).catch(err => {
                console.warn("Share dibatalkan/gagal:", err);
            });
            return;
        }

        // ==== Kalau tidak ada Web Share API ‚Üí fallback download ====
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1500);

    } catch(err){
        await themedAlert('Gagal download laporan: ' + err.message);
    }
}




    
    
    

// === Settings Modal Logic ===
(function(){
  var backdrop = document.getElementById('popupBackdrop');
  var settingsModal = document.getElementById('settingsModal');

  function showSettingsModal(){
    backdrop.hidden = false;
    settingsModal.hidden = false;
    requestAnimationFrame(function(){
      backdrop.classList.add('is-visible');
      settingsModal.classList.add('is-visible');
    });
  }
  function hideSettingsModal(){
    backdrop.classList.remove('is-visible');
    settingsModal.classList.remove('is-visible');
    setTimeout(function(){
      backdrop.hidden = true;
      settingsModal.hidden = true;
    }, 200);
  }

  document.getElementById('settingsBtn').addEventListener('click', function(){
    showSettingsModal();

    // Setup theme toggle button each time settings modal is opened
    var themeBtnInSettings = document.getElementById('themeToggleInSettings');
    if(themeBtnInSettings){
      function updateThemeBtnText(){
        var currentTheme = getTheme();
        themeBtnInSettings.textContent = (currentTheme === 'light') ? '‚òÄÔ∏è Terang' : 'üåô Gelap';
      }
      updateThemeBtnText();
      themeBtnInSettings.onclick = function(){
        var cur = getTheme();
        setTheme(cur === 'light' ? 'dark' : 'light');
        updateThemeBtnText();
      };
    }
  });

  // Close buttons inside modal
  settingsModal.querySelectorAll('[data-close]').forEach(function(btn){
    btn.addEventListener('click', hideSettingsModal);
  });

  // Navigate to Item Jajanan settings
  document.getElementById('openJajananSettings').addEventListener('click', function(){
    hideSettingsModal();
    setTimeout(function(){
      if (typeof showJajananSettingsModal === 'function') {
        showJajananSettingsModal();
      } else {
        console.error('showJajananSettingsModal function not found.');
      }
    }, 220); // wait for animation
  });
})();


// Range filter events (custom date range)
    ;(function(){
      var _from = document.getElementById('dateFrom');
      var _to = document.getElementById('dateTo');
      var _apply = document.getElementById('rangeApply');
      var _clear = document.getElementById('rangeClear');
      if(_apply){ _apply.addEventListener('click', function(){
        var f = _from && _from.value ? _from.value : '';
        var t = _to && _to.value ? _to.value : '';
        state.range = (f || t) ? {from:f, to:t} : null;
        render();
    setRangeControlsEnabled(state.filter==='RENTANG');
        try { drawDailyGraph(); } catch(e) {}
      }); }
      if(_clear){ _clear.addEventListener('click', function(){
        if(_from) _from.value='';
        if(_to) _to.value='';
        state.range = null;
        render();
    setRangeControlsEnabled(state.filter==='RENTANG');
        try { drawDailyGraph(); } catch(e) {}
      }); }
    })();


    // Cancel Edit button
    (function(){
      var cbtn = document.getElementById('cancelEditBtn');
      if(cbtn){
        cbtn.addEventListener('click', function(){
  try{
    clearForm();
    state.editingId = null;
    $('#addBtn').textContent = '+ Tambah Pencatatan';
    cbtn.style.display = 'none';
    var actionsRow = document.getElementById('formActions');
    if(actionsRow) actionsRow.classList.remove('editing');
          }catch(err){
            console.error('Cancel error:', err);
          }
        });
      }
    })();
// === Add Row simple helpers ===
    function renumberAll(tbody){
      var rows = tbody.querySelectorAll('tr');
      rows.forEach(function(tr,i){
        var first = tr.querySelector('td:first-child');
        if(first) first.textContent = (i+1);
      });
    }

    function addRowRincian(){
      var tb = document.querySelector('#rincianTable tbody');
      var tr = document.createElement('tr');
      tr.innerHTML = '<td></td>' +
        '<td><select class="select mini r-jenis"><option value="">-</option><option>PS3</option><option>PS4</option></select></td>' +
        '<td><input type="time" class="input mini r-jam"/></td>' +
        '<td><input type="number" min="0" step="0.5" placeholder="0" class="input mono mini r-jumlah"/></td>' +
        '<td><input type="number" min="0" step="100" placeholder="0" class="input mono mini rincian-harga r-harga"/></td>';
      tb.appendChild(tr);
      // wire pricing calc like initial
      (function(){
        var sel=tr.querySelector('.r-jenis'); var j=tr.querySelector('.r-jumlah'); var h=tr.querySelector('.r-harga');
        function rec(){ var RENTAL_RATE={ PS3:{hour:5000,half:3000}, PS4:{hour:7000,half:4000} }; var ps=sel.value; var r=RENTAL_RATE[ps]; var n=parseFloat(j.value); var price=0; if(r && !isNaN(n) && n>0){ var whole=Math.floor(n); var rem=Math.round((n-whole)*10)/10; price=whole*r.hour; if(Math.abs(rem-0.5)<0.001) price+=r.half; else if(rem>0) price+=Math.round(rem*r.hour);} h.value=price?String(price):''; sumRincian(); }
        sel.addEventListener('change', rec); j.addEventListener('input', rec); h.addEventListener('input', sumRincian);
      })();
      renumberAll(tb);
    }

    function addRowJajanan3x10(){
      var tb = document.querySelector('#jajananTable3x10 tbody');
      var items = Object.keys(JAJ_PRICE||{});
      var tr = document.createElement('tr');
      tr.innerHTML = '<td></td>' +
        '<td><select class="select mini j3-jenis"><option value="">-</option>'+items.map(function(x){return '<option>'+x+'</option>';}).join('')+'</select></td>' +
        '<td><input type="number" min="0" step="1" placeholder="0" class="input mono mini j3-qty"/></td>' +
        '<td><input type="time" class="input mini j3-jam"/></td>' +
        '<td><input type="number" min="0" step="100" placeholder="0" readonly class="input mono mini j3-harga"/></td>';
      tb.appendChild(tr);
      // wire price calc
      (function(){
        var sel=tr.querySelector('.j3-jenis'), qty=tr.querySelector('.j3-qty'), harga=tr.querySelector('.j3-harga');
        function recalc(){ var unit=JAJ_PRICE[sel.value]||0; var q=cleanNum(qty.value); harga.value=unit*q; sumJajanan3x10(); }
        sel.addEventListener('change', recalc); qty.addEventListener('input', recalc);
      })();
      renumberAll(tb);
    }

    function addRowJasa2x5(){
      var tb = document.querySelector('#jasaTable2x5 tbody');
      var tr = document.createElement('tr');
      tr.innerHTML = '<td></td>' +
        '<td><select class="select mini jasa-type"><option value="">-</option>'+JASA_TYPES.map(function(x){return '<option>'+x+'</option>';}).join('')+'</select></td>' +
        '<td><input type="text" class="input mini jasa-note" placeholder="keterangan (opsional)"/></td>' +
        '<td><input type="number" min="0" step="100" placeholder="0" class="input mono mini jasa-price"/></td>';
      tb.appendChild(tr);
      tr.querySelector('.jasa-price').addEventListener('input', sumJasa2x5);
      renumberAll(tb);
    }

    function addRowSewa3x10(){
      var tb = document.querySelector('#sewaTable3x10 tbody');
      var tr = document.createElement('tr');
      tr.innerHTML = '<td></td>' +
        '<td><select class="select mini sewa-jenis"><option value="">-</option>'+SEWA_TYPES.map(function(x){return '<option>'+x+'</option>';}).join('')+'</select></td>' +
        '<td><div style="display:grid;grid-template-columns:1fr 1fr;gap: var(--space-1)">' +
            '<select class="select mini sewa-durasi"><option value="">-</option><option value="12JAM">12 JAM</option><option value="1HARI">1 HARI</option><option value="2HARI">2 HARI</option><option value="3HARI">3 HARI</option></select>' +
            '<input type="text" placeholder="Isi Sendiri" class="input mini sewa-manual"/></div></td>' +
        '<td><input type="text" placeholder="note (optional)" class="input mini sewa-lama-note"/></td><td><input type="number" min="0" step="1000" placeholder="0" class="input mono mini sewa-harga"/></td>';
      tb.appendChild(tr);
      (function(){
        var selJ=tr.querySelector('.sewa-jenis'); var selD=tr.querySelector('.sewa-durasi'); var inM=tr.querySelector('.sewa-manual'); var inH=tr.querySelector('.sewa-harga');
        function recalc(){
  var manualVal = (inM.value || '').trim();
  if(manualVal){
    // User filled 'Isi Sendiri', skip auto calculation entirely
    return;
  }
  var jam = hoursFromDurasiSelect(selD.value, '');
  var price = calcSewaPrice(selJ.value, jam);
  if(price>0){ inH.value = price; }
  else { inH.value=''; }
  sumSewa3x10();
}
        selJ.addEventListener('change', recalc); selD.addEventListener('change', recalc); inM.addEventListener('input', recalc); inH.addEventListener('input', sumSewa3x10);
      })();
      renumberAll(tb);
    }

    // Bind buttons
    (function(){
      var b1 = document.getElementById('rincianAddRow'); if(b1) b1.addEventListener('click', addRowRincian);
      var b2 = document.getElementById('jajanan3x10AddRow'); if(b2) b2.addEventListener('click', addRowJajanan3x10);
      var b3 = document.getElementById('jasa2x5AddRow'); if(b3) b3.addEventListener('click', addRowJasa2x5);
      var b4 = document.getElementById('sewa3x10AddRow'); if(b4) b4.addEventListener('click', addRowSewa3x10);
    })();

    

    // === Remove Row helpers ===
    async function removeRow(tbodySelector) {
      var tb = document.querySelector(tbodySelector + ' tbody');
      if (!tb || tb.rows.length === 0) return;

      var lastRow = tb.rows[tb.rows.length - 1];
      var hasData = false;
      lastRow.querySelectorAll('input, select').forEach(function(el) {
        if (el.value && String(el.value).trim() !== '') hasData = true;
      });

      if (!hasData || await themedConfirm('Baris ini berisi data. Yakin ingin menghapusnya?')) {
        tb.deleteRow(tb.rows.length - 1);
        renumberAll(tb);
        if (tbodySelector.indexOf('rincianTable') !== -1) sumRincian();
        if (tbodySelector.indexOf('jajananTable3x10') !== -1) sumJajanan3x10();
        if (tbodySelector.indexOf('jasaTable2x5') !== -1) sumJasa2x5();
        if (tbodySelector.indexOf('sewaTable3x10') !== -1) sumSewa3x10();
      }
    }

    // Add "Remove Row" buttons beside each "Add Row" button
    (function(){
      function addRemoveBtn(afterId, handler){
        var addBtn = document.getElementById(afterId);
        if(!addBtn) return;
        var btn = document.createElement('button');
        btn.className = 'btn warn';
        btn.textContent = '- Hapus Baris';
        btn.type = 'button';
        btn.style.marginLeft = '6px';
        btn.addEventListener('click', handler);
        if (addBtn.after) addBtn.after(btn);
        else addBtn.parentNode.insertBefore(btn, addBtn.nextSibling);
      }

      addRemoveBtn('rincianAddRow', async function(){ await removeRow('#rincianTable'); });
      addRemoveBtn('jajanan3x10AddRow', async function(){ await removeRow('#jajananTable3x10'); });
      addRemoveBtn('jasa2x5AddRow', async function(){ await removeRow('#jasaTable2x5'); });
      addRemoveBtn('sewa3x10AddRow', async function(){ await removeRow('#sewaTable3x10'); });
    })();

// ===== Init
    $('#year').textContent=(new Date()).getFullYear();
          $all('#rincianTable .r-jenis').forEach(function(sel){ sel.value = ''; });
      $('#date').value=todayStr();
    load();
    // Build tables
    (function initTables(){
      // Rincian
      (function(){ var rincianBody = $('#rincianTable tbody'); rincianBody.innerHTML=''; for(var i=1;i<=10;i++){ var tr=document.createElement('tr'); tr.innerHTML = '<td>'+i+'</td><td><select class="select mini r-jenis"><option value="">-</option><option>PS3</option><option>PS4</option></select></td><td><input type="time" class="input mini r-jam"/></td><td><input type="number" min="0" step="0.5" placeholder="0" class="input mono mini r-jumlah"/></td><td><input type="number" min="0" step="100" placeholder="0" class="input mono mini rincian-harga r-harga"/></td>'; $('#rincianTable tbody').appendChild(tr);} })();
      // wire
      (function(){ $all('#rincianTable tbody tr').forEach(function(tr){ var sel=tr.querySelector('.r-jenis'); var j=tr.querySelector('.r-jumlah'); var h=tr.querySelector('.r-harga'); function rec(){ var RENTAL_RATE={ PS3:{hour:5000,half:3000}, PS4:{hour:7000,half:4000} }; var ps=sel.value; var r=RENTAL_RATE[ps]; var n=parseFloat(j.value); var price=0; if(r && !isNaN(n) && n>0){ var whole=Math.floor(n); var rem=Math.round((n-whole)*10)/10; price=whole*r.hour; if(Math.abs(rem-0.5)<0.001) price+=r.half; else if(rem>0) price+=Math.round(rem*r.hour);} h.value=price?String(price):''; sumRincian(); } sel.addEventListener('change', rec); j.addEventListener('input', rec); }); $all('.r-harga').forEach(function(inp){ inp.addEventListener('input', sumRincian); }); })();
      // Jajanan
      buildJajanan3x10();
      // Jasa
      buildJasa2x5();
      // Sewa
      buildSewa3x10();
    })();

    sumRincian(); sumJajanan3x10(); sumJasa2x5(); sumSewa3x10();
    render();
    setRangeControlsEnabled(state.filter==='RENTANG');
updateRecap();
var actionsRow=document.getElementById('formActions');
if(actionsRow) actionsRow.classList.remove('editing');
if(window.sumGrandLive) window.sumGrandLive();
updateRecap();

    // ===== Daily Graph (per-month line chart) =====
    var graphCtx = null, graphCanvas = null, graphTooltip = null;
    function colorForValue(v){
      if(v > 200000) return '#2ecc71'; // green
      if(v > 150000) return '#2980b9'; // blue
      if(v > 100000) return '#f1c40f'; // yellow
      return '#e74c3c';                // red
    }
    function ensureTooltip(){
      if(graphTooltip) return graphTooltip;
      var div = document.createElement('div');
      div.className = 'graph-tooltip';
      div.style.position = 'absolute';
      div.style.display = 'none';
      document.body.appendChild(div);
      graphTooltip = div;
      return div;
    }
    
function getMonthlySeries(){
  // RENTANG mode ‚Üí build directly from range
  if (state.filter === 'RENTANG' && state.range && (state.range.from || state.range.to)) {
    var from = state.range.from || '0000-01-01';
    var to   = state.range.to   || '9999-12-31';
    var list = state.entries.filter(function(e){
      var d = e.date || '';
      return d && d >= from && d <= to;
    });

    // Map date ‚Üí total
    var map = {};
    list.forEach(function(e){
      var tot = cleanNum(e.harian)+cleanNum(e.jajanan)+cleanNum(e.jasa)+cleanNum(e.sewa);
      map[e.date] = (map[e.date]||0) + tot;
    });

    // Generate all days from 'from' to 'to'
    var data = [];
    var start = new Date(from);
    var end = new Date(to);
    for (var dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
      var iso = new Date(dt.getTime() - dt.getTimezoneOffset()*60000).toISOString().slice(0,10);
      data.push({date: iso, value: map[iso]||0});
    }
    return { month: from + ' s/d ' + to, rows: data };
  }

  // fallback to monthly behaviour
  var monthPick = (state.filter==='ALL') ? (new Date().toISOString().slice(0,7)) : state.filter;
  var list = state.entries.filter(function(x){ return (x.date||'').slice(0,7) === monthPick; });
  var map = {};
  list.forEach(function(e){
    var tot = cleanNum(e.harian)+cleanNum(e.jajanan)+cleanNum(e.jasa)+cleanNum(e.sewa);
    map[e.date] = (map[e.date]||0) + tot;
  });
  var p = monthPick.split('-');
  var y = +p[0], m = (+p[1])-1;
  var last = new Date(y, m+1, 0);
  var data = [];
  for(var d=1; d<=last.getDate(); d++){
    var dt = new Date(y, m, d);
    var iso = new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().slice(0,10);
    data.push({date: iso, value: map[iso]||0});
  }
  return { month: monthPick, rows: data };
}


function drawDailyGraph(){
  graphCanvas = document.getElementById('dailyGraph');
  if(!graphCanvas) return;
  var rect = graphCanvas.getBoundingClientRect();
  var dpr = window.devicePixelRatio || 1;
  var cssW = graphCanvas.clientWidth || rect.width || 800;
  var cssH = graphCanvas.clientHeight || 260;
  graphCanvas.width = Math.round(cssW * dpr);
  graphCanvas.height = Math.round(cssH * dpr);
  graphCanvas.style.width = cssW + 'px';
  graphCanvas.style.height = cssH + 'px';
  graphCtx = graphCanvas.getContext('2d');
  graphCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

  var data = [];
  var caption = document.getElementById('graphCaption');

  if (state.filter === 'RENTANG' && state.range && (state.range.from || state.range.to)) {
    var from = state.range.from || '0000-01-01';
    var to   = state.range.to   || '9999-12-31';
    var list = state.entries.filter(function(e){
      var d = e.date || '';
      return d && d >= from && d <= to;
    });
    var map = {};
    list.forEach(function(e){
      var tot = cleanNum(e.harian)+cleanNum(e.jajanan)+cleanNum(e.jasa)+cleanNum(e.sewa);
      map[e.date] = (map[e.date]||0) + tot;
    });
    var start = new Date(from);
    var end = new Date(to);
    for (var dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
      var iso = new Date(dt.getTime() - dt.getTimezoneOffset()*60000).toISOString().slice(0,10);
      data.push({date: iso, value: map[iso]||0});
    }
    if(caption) caption.textContent = 'Periode: ' + from + ' s/d ' + to + ' ‚Ä¢ ' + data.length + ' hari';
  } else {
    // Month mode
    var monthPick = (state.filter==='ALL') ? (new Date().toISOString().slice(0,7)) : state.filter;
    var list = state.entries.filter(function(x){ return (x.date||'').slice(0,7) === monthPick; });
    var map = {};
    list.forEach(function(e){
      var tot = cleanNum(e.harian)+cleanNum(e.jajanan)+cleanNum(e.jasa)+cleanNum(e.sewa);
      map[e.date] = (map[e.date]||0) + tot;
    });
    var p = monthPick.split('-');
    var y = +p[0], m = (+p[1])-1;
    var last = new Date(y, m+1, 0);
    for(var d=1; d<=last.getDate(); d++){
      var dt = new Date(y, m, d);
      var iso = new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().slice(0,10);
      data.push({date: iso, value: map[iso]||0});
    }
    if(caption){
      try {
        var d = new Date(monthPick+'-01');
        caption.textContent = 'Periode: ' + d.toLocaleDateString('id-ID',{month:'long',year:'numeric'}) + ' ‚Ä¢ ' + data.length + ' hari';
      }catch(e){ caption.textContent = 'Periode: ' + monthPick; }
    }
  }

  var maxV = 0;
  data.forEach(function(r){ if(r.value>maxV) maxV=r.value; });
  var padL = 48, padR = 12, padT = 16, padB = 42;
  var W = (graphCanvas.clientWidth||cssW), H = (graphCanvas.clientHeight||cssH);
  var plotW = Math.max(10, W - padL - padR);
  var plotH = Math.max(10, H - padT - padB);
  function xAt(i){ return padL + (plotW * (i/(Math.max(1,data.length-1)))) }
  function yAt(v){ return padT + plotH - (maxV>0 ? (v/maxV)*plotH : 0); }

  graphCtx.clearRect(0,0,W,H);
  graphCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ring') || '#334';
  graphCtx.lineWidth = 1;
  graphCtx.beginPath();
  graphCtx.moveTo(padL, padT);
  graphCtx.lineTo(padL, padT+plotH);
  graphCtx.lineTo(padL+plotW, padT+plotH);
  graphCtx.stroke();

  graphCtx.font = '12px Segoe UI, Roboto, Arial, sans-serif';
  graphCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#889';
  var steps = 4;
  for(var s=0; s<=steps; s++){
    var val = Math.round((maxV * s)/steps);
    var y = yAt(val);
    graphCtx.beginPath();
    graphCtx.moveTo(padL, y);
    graphCtx.lineTo(padL+plotW, y);
    graphCtx.globalAlpha = 0.2;
    graphCtx.stroke();
    graphCtx.globalAlpha = 1;
    graphCtx.fillText((val||0).toLocaleString('id-ID'), 6, y+4);
  }

  for(var i=0;i<data.length;i++){
    var dlab = data[i].date.slice(-2);
    if(i===0 || i===data.length-1 || i%Math.ceil(data.length/6)===0){
      var x = xAt(i);
      graphCtx.fillText(dlab, x-6, padT+plotH+16);
    }
  }

  for (var i=1; i<data.length; i++){
    var prev = data[i-1];
    var curr = data[i];
    var x1 = xAt(i-1), y1 = yAt(prev.value);
    var x2 = xAt(i), y2 = yAt(curr.value);
    graphCtx.strokeStyle = colorForValue(curr.value);
    graphCtx.lineWidth = 2;
    graphCtx.beginPath();
    graphCtx.moveTo(x1, y1);
    graphCtx.lineTo(x2, y2);
    graphCtx.stroke();
  }

  graphCtx.textAlign = 'center';
  graphCtx.textBaseline = 'bottom';
  data.forEach(function(r, i){
    var x = xAt(i), y = yAt(r.value);
    var c = colorForValue(r.value);
    graphCtx.beginPath();
    graphCtx.arc(x, y, 4, 0, Math.PI*2);
    graphCtx.fillStyle = c;
    graphCtx.fill();
  });
}

    function saveGraphAsImage(){
      var cvs = document.getElementById('dailyGraph');
      if(!cvs) return;
      var a=document.createElement('a');
      a.href = cvs.toDataURL('image/png');
      var mp = (state.filter==='ALL') ? (new Date().toISOString().slice(0,7)) : state.filter;
      a.download = 'grafik_total_harian_'+mp+'.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function focusGraph(dateStr){
      var card = document.getElementById('graphCard');
      if(card){ card.classList.remove('pulse'); void card.offsetWidth; card.classList.add('pulse'); }
      if(card){ card.scrollIntoView({behavior:'smooth', block:'end'}); }
      // Optionally, we could highlight the exact point on next draw by storing target date.
      window.__graphFocusDate = dateStr || null;
    }


    // === Wire graph save + resize + theme change
    (function(){
      var sgb = document.getElementById('saveGraphBtn');
      if(sgb){ sgb.addEventListener('click', saveGraphAsImage); }
      window.addEventListener('resize', function(){ try{ drawDailyGraph(); }catch(e){} });
      var tbtn = document.getElementById('themeBtn');
      if(tbtn){
        tbtn.addEventListener('click', function(){ setTimeout(function(){ try{ drawDailyGraph(); }catch(e){} }, 50); }, { once:false });
      }
    })();

  });
})();






// === Backup & Restore Data Sub-menu ===
document.addEventListener("click", function(e){
    if(e.target && e.target.id === "openBackupRestoreSettings"){
        var backdrop = document.getElementById('popupBackdrop');
        var modal = document.getElementById('backupRestoreSettingsModal');
        backdrop.hidden = false;
        modal.hidden = false;
        requestAnimationFrame(function(){
            backdrop.classList.add('is-visible');
            modal.classList.add('is-visible');
        });
    }
});


// === Global delegation for closing Backup & Restore Data modal (returns to Settings modal) ===
document.addEventListener("click", function(e){
    if(e.target && e.target.hasAttribute("data-close")){
        var backupModal = e.target.closest("#backupRestoreSettingsModal");
        var backdrop = document.getElementById("popupBackdrop");
        var settingsModal = document.getElementById("settingsModal");
        if(backupModal){
            backupModal.classList.remove("is-visible");
            setTimeout(function(){
                backupModal.hidden = true;
                if(settingsModal){
                    settingsModal.hidden = false;
                    requestAnimationFrame(function(){
                        backdrop.classList.add('is-visible');
                        settingsModal.classList.add('is-visible');
                    });
                } else {
                    backdrop.hidden = true;
                }
            }, 200);
        }
    }
});


// === Settings Modal Tab Switch ===
document.addEventListener("click", function(e){
    if(e.target && e.target.hasAttribute("data-settings-tab")){
        var target = e.target.getAttribute("data-settings-tab");
        document.querySelectorAll("#settingsContentArea .settings-tab").forEach(function(tab){
            tab.hidden = (tab.getAttribute("data-tab") !== target);
        });
    }
});




// === Open Rincian Table Sub-Modals without hiding main backdrop ===
document.addEventListener("click", function(e){
    function openSubModal(id){
        var modal = document.getElementById(id);
        if(modal){
            modal.hidden = false;
            requestAnimationFrame(function(){
                modal.classList.add('is-visible');
            });
        }
    }
    if(e.target && e.target.id === "openJenisPSHarianSettings"){
        openSubModal("jenisPSHarianSettingsModal");
    }
    if(e.target && e.target.id === "openJasaAksesorisSettings"){
        openSubModal("jasaAksesorisSettingsModal");
    }
    if(e.target && e.target.id === "openJenisPSSewaSettings"){
        openSubModal("jenisPSSewaSettingsModal");
    }
});

// === Close only sub-modals, keep main backdrop active ===
document.addEventListener("click", function(e){
    if(e.target && e.target.hasAttribute("data-close")){
        var modal = e.target.closest(".modal");
        if(modal && modal.id !== "settingsModal"){ // avoid closing settings main modal here
            modal.classList.remove("is-visible");
            setTimeout(function(){
                modal.hidden = true;
            }, 200);
        }
    }
});


// === Toggle active state on sidebar buttons ===
document.querySelectorAll('.settings-sidebar .btn').forEach(function(btn){
    btn.addEventListener('click', function(){
        document.querySelectorAll('.settings-sidebar .btn').forEach(function(b){
            b.classList.remove('active');
        });
        btn.classList.add('active');
    });
});


// === Integrate active state with tab switching ===
document.addEventListener("click", function(e){
    if(e.target && e.target.hasAttribute("data-settings-tab")){
        // Remove active class from all sidebar buttons
        document.querySelectorAll('.settings-sidebar .btn').forEach(function(b){
            b.classList.remove('active');
        });
        // Add active class to clicked button
        e.target.classList.add('active');
    }
});

// === Export Data Sub-menu ===
document.addEventListener("click", function(e){
    if(e.target && e.target.id === "openExportDataSettings"){
        var backdrop = document.getElementById('popupBackdrop');
        var modal = document.getElementById('exportDataSettingsModal');
        backdrop.hidden = false;
        modal.hidden = false;
        requestAnimationFrame(function(){
            backdrop.classList.add('is-visible');
            modal.classList.add('is-visible');
        });
    }
    if(e.target && e.target.id === "exportCSVBtn"){
        try { exportCSV(); } catch(err){ themedAlert("Gagal ekspor CSV: " + err.message); }
    }
    if(e.target && e.target.id === "importCSVBtn"){
        var fileInput = document.getElementById('fileInput');
        if(fileInput) fileInput.click();
    }
});




// === Global delegation for closing Backup & Restore Data modal (returns to Settings modal) ===
document.addEventListener("click", function(e){
    if(e.target && e.target.hasAttribute("data-close")){
        var backupModal = e.target.closest("#backupRestoreSettingsModal");
        var backdrop = document.getElementById("popupBackdrop");
        var settingsModal = document.getElementById("settingsModal");
        if(backupModal){
            backupModal.classList.remove("is-visible");
            setTimeout(function(){
                backupModal.hidden = true;
                if(settingsModal){
                    settingsModal.hidden = false;
                    requestAnimationFrame(function(){
                        backdrop.classList.add('is-visible');
                        settingsModal.classList.add('is-visible');
                    });
                } else {
                    backdrop.hidden = true;
                }
            }, 200);
        }
    }
});








// === Event delegation for Backup & Restore ===
document.addEventListener("click", function(e){
    if(e.target && e.target.id === "backupDataBtn"){
        try {
            let allData = {};
            for(let i = 0; i < localStorage.length; i++){
                let key = localStorage.key(i);
                allData[key] = localStorage.getItem(key);
            }
            let blob = new Blob([JSON.stringify(allData, null, 2)], {type: "application/json"});
            let url = URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url;
            let now = new Date();
            let pad = function(n){return (n<10?'0':'')+n;};
            a.download = "urban_ps_backup_" + now.getFullYear() + "-" + pad(now.getMonth()+1) + "-" + pad(now.getDate()) + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch(err){
            themedAlert("Gagal backup: " + err.message);
        }
    }

    if(e.target && e.target.id === "restoreDataBtn"){
        var inputEl = document.getElementById("restoreFileInput");
        if(inputEl) inputEl.click();
    }
});

document.addEventListener("change", function(e){
    if(e.target && e.target.id === "restoreFileInput"){
        let file = e.target.files[0];
        if(!file) return;
        let reader = new FileReader();
        reader.onload = function(evt){
            try {
                let data = JSON.parse(evt.target.result);
                for(let key in data){
                    localStorage.setItem(key, data[key]);
                }
                themedAlert("Data berhasil direstore. Halaman akan dimuat ulang.", {title: "Restore Berhasil"}).then(function(){
                    location.reload();
                });
            } catch(err){
                themedAlert("Gagal restore: " + err.message);
            }
        };
        reader.readAsText(file);
    }
});


// === Global delegation for closing Export Data modal (returns to Settings modal) ===
document.addEventListener("click", function(e){
    if(e.target && e.target.hasAttribute("data-close")){
        var exportModal = e.target.closest("#exportDataSettingsModal");
        var backdrop = document.getElementById("popupBackdrop");
        var settingsModal = document.getElementById("settingsModal");
        if(exportModal){
            exportModal.classList.remove("is-visible");
            setTimeout(function(){
                exportModal.hidden = true;
                if(settingsModal){
                    settingsModal.hidden = false;
                    requestAnimationFrame(function(){
                        backdrop.classList.add('is-visible');
                        settingsModal.classList.add('is-visible');
                    });
                }
            }, 200);
        }
    }
});


// === Focus Trap for Modals ===
function trapFocus(modal) {
  const focusableEls = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  if (!focusableEls.length) return;
  const firstEl = focusableEls[0];
  const lastEl = focusableEls[focusableEls.length - 1];
  modal.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      if (e.shiftKey) { // Shift + Tab
        if (document.activeElement === firstEl) {
          e.preventDefault();
          lastEl.focus();
        }
      } else { // Tab
        if (document.activeElement === lastEl) {
          e.preventDefault();
          firstEl.focus();
        }
      }
    }
  });
}
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('transitionend', () => {
    if (!modal.hidden) trapFocus(modal);
  });
});

</script>
<!-- === Themed Popups (Alert & Confirm) === -->
<div class="modal-backdrop" hidden="" id="popupBackdrop"></div>
<div class="modal" hidden="" id="themedConfirm">
<div>
<div class="modal-header">
<div class="modal-title">Konfirmasi</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body"></div>
<div class="modal-footer">
<button class="btn" data-cancel="">Batal</button>
<button class="btn primary" data-ok="">OK</button>
</div>
</div>
</div>
<div class="modal" hidden="" id="themedAlert">
<div>
<div class="modal-header">
<div class="modal-title">Info</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body"></div>
<div class="modal-footer">
<button class="btn primary" data-ok="">OK</button>
</div>
</div>
</div>
<!-- Themed Password Modal -->
<div class="modal" hidden="" id="themedPassword">
<div>
<div class="modal-header">
<div class="modal-title">Verifikasi</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body">
<label class="mini subtle" for="pwdInput">Masukkan password untuk melanjutkan</label>
<input autocomplete="current-password" class="input" id="pwdInput" placeholder="Password admin" type="password"/>
</div>
<div class="modal-footer">
<button class="btn" data-cancel="">Batal</button>
<button class="btn primary" data-ok="">OK</button>
</div>
</div>
</div>
<!-- === /Themed Popups === -->
<!-- Main Settings Modal -->
<div class="modal" hidden="" id="settingsModal">
<div>
<div class="modal-header">
<div class="modal-title">Pengaturan</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body" style="display: flex; flex-direction: column; gap: var(--space-2);">
<style>
.settings-layout { display:flex; gap:16px; min-height: var(--ctrl-h); }
.settings-sidebar { flex:0 0 200px; background:var(--card2); border:1px solid var(--ring); border-radius: var(--radius); padding:8px; display:flex; flex-direction:column; gap: var(--space-1); }
.settings-sidebar .btn { justify-content:flex-start; }
.settings-content { flex:1; display:flex; flex-direction:column; gap: var(--space-2); }
.settings-tab[hidden] { display:none !important; }
@media(max-width:600px){
  .settings-layout { flex-direction:column; }
  .settings-sidebar { flex:0 0 auto; }
}

/* === UX ENHANCEMENTS === */
/* Hover & Active Buttons */
.btn {
  transition: transform 0.15s ease, filter 0.15s ease, background-color 0.25s ease;
}
.btn:hover {
  filter: brightness(1.05);
  transform: translateY(-1px);
}
.btn:active {
  transform: translateY(1px) scale(0.98);
}

/* Hover row on table */
table tbody tr {
  transition: background-color 0.2s ease;
}
table tbody tr:hover {
  background-color: rgba(110,168,254,0.08);
}

/* Sticky header for scrollable tables */
table thead th {
  position: sticky;
  top: 0;
  background: var(--card);
  z-index: 2;
}

/* Smooth theme transition */
body, .card, .subcard, .modal > * {
  transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
}

/* Modal open animation */
.modal > * {
  opacity: 0;
  transform: translateY(10px) scale(0.98);
  transition: opacity 0.25s ease, transform 0.25s ease;
}
.modal.is-visible > * {
  opacity: 1;
  transform: translateY(0) scale(1);
}


/* Focus-visible styles for accessibility */
button:focus-visible,
.btn:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
  box-shadow: 0 0 0 3px rgba(110,168,254,0.5);
}


/* === History Table UI Polishing === */
#table {
  width: 100%;
  border-collapse: collapse;
}
#table th, #table td {
  padding: var(--space-2) 12px;
  vertical-align: middle;
}
#table th {
  color: var(--muted);
  font-size: 13px;
  background: var(--card2);
}
#table tbody tr:hover {
  background-color: rgba(110, 168, 254, 0.08);
}
/* Tombol Edit dan Hapus */
#table .btn {
  padding: var(--space-1) 10px;
  font-size: 12px;
  border-radius: 8px;
  min-width: 50px;
}
#table .btn.warn {
  background: #d93025 !important;
  border-color: #a12016 !important;
  color: #fff !important;
}
#table .btn.warn:hover {
  filter: brightness(1.1);
}
/* Responsif */
@media (max-width: 600px) {
  #table th, #table td {
    padding: 8px 6px;
    font-size: 12px;
  }
  #table .btn {
    padding: 4px 8px;
    font-size: 11px;
  }
}
</style>
<div class="settings-layout">
<!-- Sidebar kiri -->
<div class="settings-sidebar">
<button class="btn" data-settings-tab="theme"><span class="emoji">‚öôÔ∏è</span> General</button>
<button class="btn" data-settings-tab="jajanan"><span class="emoji">üìù</span>Edit Rincian</button>
<button class="btn" data-settings-tab="backup"><span class="emoji">üì¶</span>Backup &amp; Restore Data</button>
<button class="btn" data-settings-tab="export"><span class="emoji">üì§</span>Export Data</button>
</div>
<!-- Konten kanan -->
<div class="settings-content" id="settingsContentArea">
<!-- Tab: Theme -->
<div class="settings-tab" data-tab="theme">
<div style="display:flex;align-items:center;justify-content:space-between;">
<span>Mode Tema</span>
<button class="btn" id="themeToggleInSettings"><span class="emoji">üåô</span>Gelap</button>
</div>
</div>
<!-- Tab: Jajanan -->
<div class="settings-tab" data-tab="jajanan" hidden="">
<div style="display:flex;flex-direction:column;gap: var(--space-2);">
<button class="btn" id="openJenisPSHarianSettings">Item Jenis PS Pemasukan Harian</button>
<button class="btn" id="openJajananSettings">Item Jajanan</button>
<button class="btn" id="openJasaAksesorisSettings">Item Jasa &amp; Aksesori</button>
<button class="btn" id="openJenisPSSewaSettings">Item Jenis PS Pemasukan Sewa PS</button>
</div>
</div>
<!-- Tab: Backup & Restore -->
<div class="settings-tab" data-tab="backup" hidden="">
<div style="display:flex;flex-direction:column;gap: var(--space-2);">
<button class="btn" id="backupDataBtn"><span class="emoji">üíæ</span>Backup Data</button>
<button class="btn" id="restoreDataBtn"><span class="emoji">üìÇ</span>Restore Data</button>
<input accept=".json" id="restoreFileInput" style="display:none;" type="file"/>
</div>
</div>
<!-- Tab: Export -->
<div class="settings-tab" data-tab="export" hidden="">
<div style="display:flex;flex-direction:column;gap: var(--space-2);">
<button class="btn" id="exportCSVBtn"><span class="emoji">üìÑ</span>Ekspor CSV</button>
</div>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn" data-close="">Batal</button>
</div>
</div>
</div>
<!-- Export Data Modal -->
<!-- Backup & Restore Data Modal -->
<div class="modal" hidden="" id="backupRestoreSettingsModal">
<div>
<div class="modal-header">
<div class="modal-title">Backup &amp; Restore Data</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body" style="display: flex; flex-direction: column; gap: var(--space-2);">
<button class="btn" id="backupDataBtn"><span class="emoji">üíæ</span>Backup Data</button>
<button class="btn" id="restoreDataBtn"><span class="emoji">üìÇ</span>Restore Data</button>
<input accept=".json" id="restoreFileInput" style="display:none;" type="file"/>
</div>
<div class="modal-footer">
<button class="btn" data-close="">Tutup</button>
</div>
</div>
</div>
<div class="modal" hidden="" id="exportDataSettingsModal">
<div>
<div class="modal-header">
<div class="modal-title">Export Data</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body" style="display: flex; flex-direction: column; gap: var(--space-2);">
<button class="btn" id="exportCSVBtn"><span class="emoji">üìÑ</span>Ekspor CSV</button>
</div>
<div class="modal-footer">
<button class="btn" data-close="">Tutup</button>
</div>
</div>
</div>
<!-- Pengaturan Jajanan Modal -->
<div class="modal" hidden="" id="jajananSettingsModal">
<div>
<div class="modal-header">
<div class="modal-title">Pengaturan Jajanan</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body">
<table id="jajananSettingsTable" style="width:100%;border-collapse:collapse;margin-bottom:12px">
<thead>
<tr><th style="text-align:left;padding: var(--space-1)">Nama Jajanan</th><th style="text-align:left;padding: var(--space-1)">Harga (Rp)</th><th style="padding: var(--space-1)">Aksi</th></tr>
</thead>
<tbody></tbody>
</table>
<button class="btn" id="addJajananItemBtn" type="button">+ Tambah Item</button>
</div>
<div class="modal-footer">
<button class="btn" data-cancel="">Batal</button>
<button class="btn primary" id="saveJajananSettingsBtn">Simpan</button>
</div>
</div>
</div>
<!-- Jenis PS Harian Modal -->
<div class="modal" hidden="" id="jenisPSHarianSettingsModal">
<div>
<div class="modal-header">
<div class="modal-title">Item Jenis PS Pemasukan Harian</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body" style="max-height:60vh;overflow:auto;">
<table id="jenisPSHarianTable" style="width:100%;border-collapse:collapse;margin-bottom:12px">
<thead><tr><th>Jenis PS</th><th>Harga (Rp)</th><th>Aksi</th></tr></thead>
<tbody></tbody>
</table>
<button class="btn" id="addJenisPSHarianBtn" type="button">+ Tambah Jenis PS</button>
</div>
<div class="modal-footer">
<button class="btn" id="saveJenisPSHarianBtn">Simpan</button>
<button class="btn" data-close="">Tutup</button>
</div>
</div>
</div>
<!-- Jasa & Aksesoris Modal -->
<div class="modal" hidden="" id="jasaAksesorisSettingsModal">
<div>
<div class="modal-header">
<div class="modal-title">Item Jasa &amp; Aksesoris</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body" style="max-height:60vh;overflow:auto;">
<table id="jasaAksesorisTable" style="width:100%;border-collapse:collapse;margin-bottom:12px">
<thead><tr><th>Nama Jasa/Aksesoris</th><th>Harga (Rp)</th><th>Aksi</th></tr></thead>
<tbody></tbody>
</table>
<button class="btn" id="addJasaAksesorisBtn" type="button">+ Tambah Jasa/Aksesoris</button>
</div>
<div class="modal-footer">
<button class="btn" id="saveJasaAksesorisBtn">Simpan</button>
<button class="btn" data-close="">Tutup</button>
</div>
</div>
</div>
<!-- Jenis PS Sewa Modal -->
<div class="modal" hidden="" id="jenisPSSewaSettingsModal">
<div>
<div class="modal-header">
<div class="modal-title">Item Jenis PS Pemasukan Sewa PS</div>
<button class="modal-close" data-close="">‚úï</button>
</div>
<div class="modal-body" style="max-height:60vh;overflow:auto;">
<table id="jenisPSSewaTable" style="width:100%;border-collapse:collapse;margin-bottom:12px">
<thead><tr><th>Jenis PS</th><th>Harga (Rp)</th><th>Aksi</th></tr></thead>
<tbody></tbody>
</table>
<button class="btn" id="addJenisPSSewaBtn" type="button">+ Tambah Jenis PS</button>
</div>
<div class="modal-footer">
<button class="btn" id="saveJenisPSSewaBtn">Simpan</button>
<button class="btn" data-close="">Tutup</button>
</div>
</div>
</div>
<script>
(function(){
  function updateDayField(){
    var dateInput = document.getElementById('date');
    var dayInput = document.getElementById('day');
    if(!dateInput || !dayInput) return;
    if(!dateInput.value){
      dayInput.value = '';
      return;
    }
    try{
      var opts = { weekday: 'long' };
      var d = new Date(dateInput.value);
      dayInput.value = d.toLocaleDateString('id-ID', opts);
    }catch(e){
      dayInput.value = '';
    }
  }
  var dateInput = document.getElementById('date');
  if(dateInput){
    dateInput.addEventListener('input', updateDayField);
    dateInput.addEventListener('change', updateDayField);
    // Init on load after slight delay to catch programmatic changes
    setTimeout(updateDayField, 50);
    // Expose globally so other code can trigger it
    window.updateDayField = updateDayField;
  }
})();
</script>

<script>
// ===== Online Sync (Google Apps Script + Google Sheet with Snapshot + History) =====
const API_URL = 'https://script.google.com/macros/s/AKfycbx4Ad8_LHw3c0akzr0MD8roEysj4UvLvDePdAH6LB4fIDfp8J6PziUU4czcjapZNNrZOA/exec';  // ganti dengan Web App URL kamu
const USE_ONLINE = !!API_URL && API_URL.indexOf('http') === 0;

async function api(action, payload) {
  if (!USE_ONLINE) return { ok:false, error:'offline-disabled' };
  const isList = (action === 'list' || action === 'history');
  const url = isList ? API_URL + '?action=' + action : API_URL;
  const opts = isList ? { method:'GET' } : {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(Object.assign({ action }, payload||{}))
  };
  const res = await fetch(url, opts);
  try { return await res.json(); } catch (e) { return { ok:false, error:'bad-json' }; }
}

let __REMOTE_DUMP__ = null;

// Save -> update snapshot + append ke history
function save(){
  try { localStorage.setItem('urban_ps_pembukuan', JSON.stringify(state.entries)); } catch(e){}
  if (USE_ONLINE){
    api('save', { entries: state.entries, user: 'Fauzan' }).then(function(resp){
      if (resp && resp.ok){
        __REMOTE_DUMP__ = JSON.stringify(state.entries);
      }
    }).catch(function(e){ console.error(e); });
  }
}

// Load snapshot terbaru
function load(){
  try { state.entries = JSON.parse(localStorage.getItem('urban_ps_pembukuan') || '[]'); } catch(e){ state.entries = []; }
  if (USE_ONLINE){
    api('list').then(function(resp){
      if (resp && resp.entries){
        var dump = JSON.stringify(resp.entries);
        __REMOTE_DUMP__ = dump;
        if (dump !== JSON.stringify(state.entries)){
          state.entries = resp.entries;
          try { localStorage.setItem('urban_ps_pembukuan', dump); } catch(e){}
          if (typeof render === 'function') render();
          if (typeof setRangeControlsEnabled === 'function') setRangeControlsEnabled(state.filter==='RENTANG');
        }
      }
    }).catch(function(e){ console.error(e); });
  }
}

// Auto-sync setiap 15s
if (USE_ONLINE){
  setInterval(function(){
    api('list').then(function(resp){
      if (!resp || !Array.isArray(resp.entries)) return;
      var dump = JSON.stringify(resp.entries);
      if (dump !== __REMOTE_DUMP__){
        __REMOTE_DUMP__ = dump;
        state.entries = resp.entries;
        try { localStorage.setItem('urban_ps_pembukuan', dump); } catch(e){}
        if (typeof render === 'function') render();
        if (typeof setRangeControlsEnabled === 'function') setRangeControlsEnabled(state.filter==='RENTANG');
      }
    }).catch(function(e){ /* ignore */ });
  }, 15000);
}
</script>

</body>
</html>